<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paddentelominator Ultimate Pro Xtreme 2026</title>
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' font-size='48'%3Eüê∏%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="./version.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .active-tab { border-bottom: 3px solid #10b981; color: #10b981; }
        .counter-btn { transition: transform 0.1s active; position: relative; overflow: hidden; }
        .counter-btn:active { transform: scale(0.95); }
        .minus-btn { font-size: 0.8rem; }
        ::-webkit-scrollbar { display: none; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        #canvas-fx { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 100; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #update-btn { z-index: 120; }
        @keyframes recPulse { 0% { transform: scale(0.9); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.6; } }
        .animate-rec { animation: recPulse 1s infinite; }
        .record-btn { width: 34px; height: 34px; border-radius: 9999px; border: 1px solid rgba(248,113,113,0.5); background: rgba(248,113,113,0.12); display: inline-flex; align-items: center; justify-content: center; }
        .record-btn:active { transform: scale(0.96); }
        /* Emojis en letters */
        .icon-lg { font-size: 18px; line-height: 1; display: inline-block; color: #fff; vertical-align: -3px; }
        .icon-img { width: 24px; height: 24px; display: inline-block; vertical-align: -4px; }
        .brand-title { font-family: 'Orbitron', 'Inter', sans-serif; letter-spacing: 0.08em; text-transform: uppercase; }
        /* Determinatie checkboxes duidelijk zichtbaar, ook zonder Tailwind accent */
        .checkbox-det { width:16px; height:16px; border:1px solid #34d399; border-radius:4px; accent-color:#10b981; background:#0f172a; }
        .det-result-banner { background: linear-gradient(135deg,#10b981,#22d3ee); color:#0b1a13; padding:12px 14px; border-radius:12px; font-weight:800; font-size:15px; text-transform:uppercase; letter-spacing:0.02em; box-shadow:0 8px 24px rgba(16,185,129,0.25); }
        .det-thumb img { border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.35); }
        .det-question-wrap { display:flex; flex-direction:column; align-items:center; text-align:center; }
        .det-modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); z-index:300; display:flex; align-items:center; justify-content:center; }
        .det-modal-card { background:#0f172a; border:1px solid rgba(16,185,129,0.35); border-radius:20px; padding:18px; max-width:420px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.5); text-align:center; }
        .rarity-pill { display:inline-block; padding:4px 10px; border-radius:9999px; font-size:11px; font-weight:700; }
        .brand-wrap { display: flex; align-items: center; gap: 0.35rem; flex-wrap: wrap; }
        .brand-sub { white-space: nowrap; }
        @media (max-width: 480px) {
            .brand-wrap { flex-direction: column; align-items: flex-start; }
            .brand-sub { white-space: normal; margin-top: -4px; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 pb-24">

    <canvas id="canvas-fx"></canvas>
    <input type="file" accept="image/*" capture="environment" onchange="handlePhoto(event)" id="photo-input" class="hidden">

    <!-- Header -->
    <header class="bg-gray-800 px-3 py-2 shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center">
            <h1 class="text-lg font-bold text-white brand-wrap leading-tight">
                <span class="text-base">üê∏</span>
                <span class="text-emerald-400 brand-title text-base">Paddentelominator</span>
                <span class="text-[10px] uppercase tracking-[0.18em] text-gray-400 brand-sub">Ultra Pro Xtreme 2026</span>
            </h1>
            <div id="pwa-status" class="flex flex-col items-end gap-0.5 text-[9px] cursor-pointer" title="Offline gereed">
                <div class="flex items-center gap-1 text-gray-400 bg-gray-900/60 px-2 py-1 rounded-full border border-gray-700">
                    <span id="status-icon" class="status-dot bg-gray-600"></span>
                    <span id="status-text" class="hidden"></span>
                </div>
                <div class="font-bold text-gray-500 uppercase tracking-tight">v<span id="app-version-display">11</span></div>
            </div>
        </div>
        <div class="mt-2 flex flex-col gap-2">
            <div class="flex gap-2 items-center">
                <input type="date" id="datePicker" class="bg-gray-700 border-none rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-emerald-500 text-white w-full shadow-inner">
                <div class="flex items-center gap-1.5">
                    <button id="record-btn" onclick="endSession()" class="hidden record-btn" title="Stop sessie">
                        <span id="record-dot" class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_0_6px_rgba(248,113,113,0.25)] animate-rec"></span>
                    </button>
                    <button id="new-session-btn" onclick="startSession(true)" class="bg-emerald-700 px-3 py-2 rounded text-[10px] font-bold uppercase tracking-widest flex items-center gap-1">
                        <span class="text-xs">‚è∫</span> Nieuwe sessie
                    </button>
                </div>
            </div>
        </div>
        
        <div id="undo-container" class="mt-2 hidden">
            <button onclick="undo()" class="w-full bg-orange-600/20 border border-orange-500 text-orange-400 text-[10px] py-2 rounded uppercase tracking-widest font-bold flex items-center justify-center gap-2 shadow-lg">
                ‚Ü©Ô∏è Herstel laatste tik
            </button>
        </div>
    </header>

    <!-- Navigatie -->
    <nav class="flex bg-gray-800 border-b border-gray-700 text-[10px] font-bold sticky top-[78px] z-40 overflow-x-auto whitespace-nowrap no-scrollbar shadow-md">
        <button onclick="switchTab('count')" id="tab-count" class="px-5 py-3 active-tab uppercase tracking-tight">üßÆ Tellen</button>
        <button onclick="switchTab('sessions')" id="tab-sessions" class="px-5 py-3 uppercase tracking-tight">üìí Sessie log</button>
        <button onclick="switchTab('report')" id="tab-report" class="px-5 py-3 uppercase tracking-tight">üìä Rapport</button>
        <button onclick="switchTab('settings')" id="tab-settings" class="px-5 py-3 uppercase tracking-tight">‚öôÔ∏è Instellingen</button>
        <button onclick="switchTab('help')" id="tab-help" class="px-5 py-3 uppercase tracking-tight">üîç Determinatiehulp</button>
        <button onclick="switchTab('info')" id="tab-info" class="px-5 py-3 uppercase tracking-tight">‚ÑπÔ∏è Info</button>
    </nav>

    <main class="p-4">
        <button id="camera-fab" onclick="triggerPhoto()" class="fixed right-3 bottom-24 bg-purple-700 text-white w-12 h-12 rounded-full shadow-2xl flex items-center justify-center text-2xl z-[105] border border-purple-400/60">üì∏</button>
        <!-- TAB 1: TELLEN -->
        <section id="view-count" class="space-y-6">
            <div id="render-target" class="space-y-6"></div>
            <div id="custom-species-render" class="space-y-6"></div>

            <div class="bg-gray-800 p-6 rounded-xl border border-emerald-500/30 space-y-3">
                <h3 class="font-bold mb-4 text-emerald-400">Nieuwe soort toevoegen</h3>
                <div class="flex gap-2">
                    <input type="text" id="new-species-name" placeholder="Bijv: Groene Kikker..." class="flex-grow bg-gray-700 border-none rounded px-3 py-2 text-sm text-white">
                    <button onclick="addCustomSpecies()" class="bg-emerald-600 px-4 py-2 rounded font-bold text-sm">OK</button>
                </div>
                <div id="custom-species-list" class="space-y-2"></div>
            </div>
            
            <button onclick="resetCurrentDate()" class="w-full py-8 text-gray-600 text-[10px] uppercase tracking-widest font-bold border-2 border-dashed border-gray-800 rounded-xl mt-10">
                Alles wissen voor vandaag
            </button>
        </section>

        <!-- TAB 2: SESSIE LOG -->
        <section id="view-sessions" class="hidden space-y-4">
            <div class="flex items-center gap-2 text-[11px] text-gray-300 bg-gray-800/70 border border-gray-700 px-3 py-2 rounded">
                <span class="uppercase font-bold text-gray-400 text-[10px]">Sessie</span>
                <select id="session-log-select" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 flex-1 text-white text-[11px]" onchange="setViewedSession(this.value)"></select>
            </div>
            <div class="text-[11px] text-gray-400">
                Beheer per sessie: weer, trajectnaam, notities en foto's.
            </div>
            <datalist id="route-suggestions"></datalist>
            <div id="session-log-container" class="space-y-4"></div>
        </section>

        <!-- TAB 4: RAPPORT -->
        <section id="view-report" class="hidden space-y-6 text-center">
            <div class="bg-gray-800 p-4 rounded-xl border border-emerald-500/30 space-y-3 text-left">
                <div class="flex items-center gap-2 text-[10px] text-gray-300">
                    <span>Sessie:</span>
                    <select id="report-session-select" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 flex-1 text-left text-white" onchange="updateReport()"></select>
                    <button class="text-[10px] bg-gray-700 px-2 py-1 rounded" onclick="setReportMode('session')">Per sessie</button>
                    <button class="text-[10px] bg-gray-700 px-2 py-1 rounded" onclick="setReportMode('day')">Hele dag</button>
                </div>
                <div id="report-text" class="bg-gray-900 p-3 rounded-lg font-mono text-left text-[11px] border border-emerald-500/30 whitespace-pre-wrap leading-relaxed"></div>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="copyReport()" class="w-full bg-emerald-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:bg-emerald-700 text-xs uppercase tracking-widest">
                        üìã Kopieer rapport
                    </button>
                    <button onclick="shareReport()" class="w-full bg-purple-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:bg-purple-800 text-xs uppercase tracking-widest">
                        üì§ Deel rapport
                    </button>
                    <button onclick="shareReport(true)" class="w-full bg-purple-900/70 border border-purple-400/30 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:bg-purple-900 text-xs uppercase tracking-widest">
                        üì∏ Deel met foto's
                    </button>
                    <button onclick="exportReportCSV()" class="w-full bg-indigo-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:bg-indigo-700 text-xs uppercase tracking-widest">
                        ‚¨áÔ∏è Exporteer CSV van vandaag
                    </button>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-purple-500/30 space-y-3 text-left">
                <div class="flex items-center justify-between">
                    <h3 class="font-bold text-purple-200 text-sm">Determinaties</h3>
                    <button onclick="shareDeterminaties()" class="bg-purple-700 px-3 py-2 rounded text-[11px] font-bold uppercase tracking-widest">üì§ Deel</button>
                </div>
                <div id="report-dets" class="space-y-2 text-[11px] text-gray-200"></div>
            </div>
        </section>

        <!-- TAB 6: INSTELLINGEN -->
        <section id="view-settings" class="hidden space-y-4">
            <h2 class="text-xl font-bold text-emerald-400 text-center">‚öôÔ∏è Instellingen</h2>
            <div class="bg-gray-800 p-4 rounded-xl border border-emerald-500/30 space-y-3">
                <h3 class="font-bold text-emerald-300 text-sm">Sessiemanagement</h3>
                <div class="flex gap-2 items-center">
                    <input type="date" id="sessionDate" class="bg-gray-700 border-none rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-emerald-500 text-white w-full shadow-inner">
                    <button onclick="startSession(true, true)" class="bg-emerald-700 px-3 py-2 rounded text-[10px] font-bold uppercase tracking-widest">Start op datum</button>
                </div>
                <div id="session-admin-list" class="space-y-2 text-[11px]"></div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-purple-500/30 space-y-3">
                <h3 class="font-bold mb-2 text-purple-300">Export & Import (QR)</h3>
                <div class="flex gap-2 mb-2 text-[10px] text-gray-300 items-center">
                    <span>Data:</span>
                    <select id="qr-session-select" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 flex-1 text-left text-white" onchange="generateQR();updateQrSummary();"></select>
                </div>
                <div class="flex flex-col md:flex-row gap-3 items-start">
                    <div id="qrcode-area" class="bg-white p-3 rounded-lg inline-block mx-auto md:mx-0 border-4 border-purple-500"></div>
                    <div class="flex-1 text-[11px] text-gray-300 bg-gray-900/60 border border-gray-700 rounded p-3" id="qr-summary-box">
                        Scan deze code om tellingen te ontvangen.
                    </div>
                </div>
                <button onclick="generateQR()" class="w-full bg-purple-600 py-3 rounded-lg font-bold uppercase text-xs">Refresh QR</button>
                <div class="h-px bg-purple-500/30 my-2"></div>
                <h4 class="text-purple-200 font-bold text-sm">Importeer</h4>
                <div class="text-[11px] text-gray-400 mb-2">
                    QR-import is bedoeld om met twee personen op verschillende stukken van een traject te tellen en nadien de tellingen samen te voegen.
                    Alleen aantallen worden gedeeld, geen foto‚Äôs. Kies hieronder waar de telling wordt bijgeboekt en start daarna de scan.
                </div>
                <label class="text-[10px] text-gray-300 font-bold uppercase">Bijtellen in</label>
                <select id="import-target-select" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white w-full text-[12px]" onchange="updateImportTargetHint()"></select>
                <div id="import-target-hint" class="text-[11px] text-gray-400 bg-gray-900/70 border border-gray-700 rounded px-2 py-2"></div>
                <button onclick="startSessionScanner()" class="w-full bg-purple-600 py-3 rounded-lg font-bold uppercase text-xs">Scan QR</button>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-indigo-500/30 space-y-3">
                <h3 class="font-bold text-indigo-300 text-sm">CSV Import</h3>
                <p class="text-[11px] text-gray-300">Importeer CSV‚Äôs zoals je ze exporteert (kolommen: Datum; Soort; Koppels levend; Koppels dood; M/V/Onb levend/dood).</p>
                <input type="file" accept=".csv,text/csv" id="csv-import-input" class="block w-full text-[11px] text-gray-300 bg-gray-700 border border-gray-600 rounded px-2 py-2">
                <button onclick="handleCSVImport()" class="w-full bg-indigo-600 py-3 rounded-lg font-bold uppercase text-xs">‚¨ÜÔ∏è Importeer CSV</button>
                <div id="csv-import-result" class="text-[10px] text-gray-400"></div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-indigo-400/30 space-y-3">
                <h3 class="font-bold text-indigo-200 text-sm">CSV Export</h3>
                <p class="text-[11px] text-gray-300">Exporteer dag of sessie van de huidige datum, of een datumrange.</p>
                <div class="grid grid-cols-2 gap-2 text-[11px] text-gray-200">
                    <div class="space-y-1">
                        <label class="uppercase tracking-wide text-[9px] text-gray-400">Van</label>
                        <input type="date" id="csv-from-settings" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white w-full">
                    </div>
                    <div class="space-y-1">
                        <label class="uppercase tracking-wide text-[9px] text-gray-400">Tot</label>
                        <input type="date" id="csv-to-settings" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white w-full">
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="exportAllSessionsCSV()" class="w-full bg-indigo-600 py-2 rounded-lg font-bold uppercase text-xs">‚¨áÔ∏è Exporteer alle sessies (vandaag)</button>
                    <button onclick="exportRangeCSV(true)" class="w-full bg-indigo-500 py-2 rounded-lg font-bold uppercase text-xs">‚¨áÔ∏è Exporteer alle sessies (range)</button>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-amber-500/30 space-y-3">
                <h3 class="font-bold text-amber-200 text-sm flex items-center gap-2">Dev: Storage inspector <span class="text-[9px] bg-amber-500/20 border border-amber-400/30 text-amber-100 px-2 py-1 rounded">Alleen lokaal</span></h3>
                <p class="text-[11px] text-gray-300">Bekijk wat er precies in <code>localStorage</code> staat. Handig om te controleren of foto-data er nog is na een update.</p>
                <div class="flex gap-2 items-center text-[11px]">
                    <input id="storage-search" type="text" placeholder="Zoek in keys of inhoud" class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-2 text-white" oninput="renderStorageInspector()">
                    <button onclick="renderStorageInspector(true)" class="bg-amber-600 px-3 py-2 rounded font-bold text-[11px] uppercase tracking-widest">Herlaad</button>
                </div>
                <div id="storage-meta" class="text-[10px] text-gray-400"></div>
                <div id="storage-inspector" class="space-y-2 max-h-72 overflow-auto no-scrollbar text-[11px]"></div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-red-500/30 space-y-3">
                <h3 class="font-bold text-red-300 text-sm">Databeheer foto's</h3>
                <div class="flex items-center gap-2">
                    <input type="date" id="photo-clean-date" class="bg-gray-700 border-none rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-emerald-500 text-white w-full shadow-inner" value="">
                    <button onclick="clearAllPhotos(document.getElementById('photo-clean-date').value || picker.value)" class="bg-red-800 px-3 py-2 rounded text-[10px] text-white">Wis dag</button>
                </div>
                <button onclick="clearAllPhotos()" class="w-full bg-red-900/40 border border-red-700 text-red-200 py-2 rounded text-[11px]">Wis alle foto's</button>
            </div>
        </section>

        <!-- TAB 7: DETERMINATIEHULP -->
        <section id="view-help" class="hidden space-y-4 text-sm">
            <h2 class="text-xl font-bold text-emerald-400 text-center">üîç Determinatiehulp</h2>

            <!-- Foto capture + preview -->
            <input type="file" accept="image/*" capture="environment" id="det-photo-input" class="hidden" onchange="handleDetPhoto(event)">
            <div class="bg-gray-800 p-4 rounded-xl border border-emerald-500/30 space-y-3">
                <div class="flex items-center justify-between gap-2">
                    <div>
                        <div class="text-[11px] uppercase text-gray-400 font-bold">Actieve sessie</div>
                        <div id="det-session-label" class="text-sm text-white">Geen sessie</div>
                    </div>
                    <div class="flex gap-2">
                        <button id="det-start-session-btn" onclick="startSession(true)" class="bg-emerald-700 px-3 py-2 rounded text-[10px] font-bold uppercase tracking-widest">Start sessie</button>
                        <button id="det-loose-btn" onclick="startLooseDetermination()" class="bg-amber-700 px-3 py-2 rounded text-[10px] font-bold uppercase tracking-widest hidden">Start losse determinatie</button>
                        <button id="det-new-btn" onclick="beginDetermination()" class="bg-purple-700 px-3 py-2 rounded text-[10px] font-bold uppercase tracking-widest">Nieuwe determinatie</button>
                    </div>
                </div>

                <!-- Foto's bovenaan -->
                <div class="bg-gray-900/60 border border-gray-700 rounded-lg p-3 space-y-2">
                    <div class="flex items-center justify-between text-[10px] uppercase text-gray-400 font-bold">
                        <span>Foto's (max 3)</span>
                        <button onclick="triggerDetPhoto()" class="bg-gray-700 px-2 py-1 rounded text-[10px] text-white">‚ûï Foto</button>
                    </div>
                    <div id="det-photo-strip" class="grid grid-cols-3 gap-2"></div>
                    <div class="text-[10px] text-gray-500">Tik op een foto om te vergroten.</div>
                </div>

                <!-- Vraagkaart -->
                <div id="det-question-card" class="bg-gray-900/60 border border-gray-700 rounded-lg p-3 space-y-3 hidden det-question-wrap">
                    <div class="text-[10px] uppercase text-gray-400 font-bold">Vraag</div>
                    <div class="flex flex-col md:flex-row gap-3 items-start">
                        <div class="flex-1 space-y-2 det-question-wrap">
                            <div id="det-question" class="text-base font-bold text-white min-h-[48px] flex items-center justify-center text-center">Start een determinatie.</div>
                            <div class="grid grid-cols-2 gap-4 px-4">
                                <button id="det-btn-yes" onclick="answerDetermination('yes')" class="bg-emerald-700 hover:bg-emerald-600 text-white py-3 px-4 rounded-xl font-bold uppercase text-sm disabled:opacity-40">JA</button>
                                <button id="det-btn-no" onclick="answerDetermination('no')" class="bg-red-700 hover:bg-red-600 text-white py-3 px-4 rounded-xl font-bold uppercase text-sm disabled:opacity-40">NEE</button>
                            </div>
                            <div class="flex gap-2 px-2">
                                <button id="det-btn-back" onclick="goBackDetermination()" class="flex-1 bg-gray-800 text-white py-2 rounded-lg text-[11px]">‚¨ÖÔ∏é Vorige vraag</button>
                                <button id="det-btn-reset" onclick="resetDetermination()" class="flex-1 bg-gray-700 text-white py-2 rounded-lg text-[11px]">üîÑ Herstart</button>
                            </div>
                            <div id="det-progress" class="text-[10px] text-gray-400"></div>
                            <div id="det-result" class="space-y-2"></div>
                            <div id="det-thumb-box" class="det-thumb hidden">
                                <img id="det-thumb-img" src="" alt="Soort afbeelding" class="w-full max-w-sm mx-auto object-cover">
                            </div>
                        <div id="det-apply" class="hidden space-y-2">
                            <button onclick="applyDeterminationToCounts()" class="w-full bg-emerald-600 py-2 rounded-lg font-bold uppercase text-xs">Voeg toe aan teller</button>
                            <div id="det-warning" class="text-[10px] text-orange-300 bg-orange-900/30 border border-orange-700 rounded p-2 hidden">Let op: bij her-determinatie wordt de vorige telling niet automatisch gecorrigeerd. Pas zelf -1/+1 aan indien nodig.</div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historiek / bewerken -->
            <div class="bg-gray-800 p-4 rounded-xl border border-blue-500/30 space-y-3">
                <div class="flex items-center justify-between">
                    <h3 class="font-bold text-blue-200 text-sm">Determinaties in deze sessie</h3>
                    <select id="det-session-select" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-[11px]" onchange="renderDetSessionOptions(); renderDeterminationUI(); renderDeterminationList();"></select>
                </div>
                <div id="det-list" class="space-y-2 text-[11px]"></div>
            </div>
        </section>

        <!-- TAB 8: INFO -->
        <section id="view-info" class="hidden space-y-4 text-sm">
            <h2 class="text-xl font-bold text-emerald-400 text-center">‚ÑπÔ∏è Info & Werking</h2>
            <div class="bg-gray-800 p-4 rounded-xl border border-emerald-500/30 space-y-3">
                <h3 class="font-bold text-emerald-300 text-sm">Tellen</h3>
                <ul class="list-disc list-inside text-gray-200 space-y-1">
                    <li>Kies de dag bovenaan; start een sessie om te tellen.</li>
                    <li>Knoppen links = levend, rechts = dood. Paartje telt automatisch als 2 stuks.</li>
                    <li>Foto maken: knop in Tellen of via Sessie log per sessie.</li>
                </ul>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-blue-500/30 space-y-3">
                <h3 class="font-bold text-blue-300 text-sm">Sessies & Log</h3>
                <ul class="list-disc list-inside text-gray-200 space-y-1">
                    <li>Sessies splitsen een avond in tijdsblokken (bijv. shift 1 en 2) zodat aantallen per blok zichtbaar blijven.</li>
                    <li>In Sessie log zie je per sessie totaal, weer, traject en foto‚Äôs.</li>
                    <li>Traject heeft suggestielijst van eerder gelopen routes.</li>
                    <li>Foto aanklikken = grote weergave; delen kan per sessie.</li>
                    <li>Sessies samenvoegen kan via Instellingen ‚Üí Sessiemanagement.</li>
                </ul>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-purple-500/30 space-y-3">
                <h3 class="font-bold text-purple-300 text-sm">Rapport & Delen</h3>
                <ul class="list-disc list-inside text-gray-200 space-y-1">
                    <li>Kies sessie of hele dag; delen via Share/WhatsApp met of zonder foto‚Äôs.</li>
                    <li>QR-export toont wat ontvangers zullen bijtellen.</li>
                </ul>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-amber-500/30 space-y-3">
                <h3 class="font-bold text-amber-300 text-sm">QR Import</h3>
                <ul class="list-disc list-inside text-gray-200 space-y-1">
                    <li>Twee personen kunnen elk een deel van het traject tellen en achteraf de QR scannen om de aantallen samen te voegen.</li>
                    <li>Alleen aantallen worden gedeeld; foto‚Äôs blijven lokaal.</li>
                    <li>Kies ‚ÄúBijtellen in‚Äù (dag of specifieke sessie) v√≥√≥r het scannen.</li>
                </ul>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-red-500/30 space-y-3">
                <h3 class="font-bold text-red-300 text-sm">Data & Offline</h3>
                <ul class="list-disc list-inside text-gray-200 space-y-1">
                    <li>Alles staat lokaal in de browser; PWA werkt offline na eerste gebruik.</li>
                    <li>Instellingen ‚Üí Databeheer: foto‚Äôs per dag of alles verwijderen.</li>
                </ul>
            </div>
            <p class="text-[11px] text-gray-500 text-center mt-2">App gemaakt door Jasper Cuvelier.</p>
        </section>
    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-emerald-600 text-white px-6 py-3 rounded-full shadow-2xl hidden z-[110] transition-all opacity-0 font-bold border border-emerald-400/30">
        Actie gelukt!
    </div>
    <button id="update-btn" class="hidden fixed right-4 bottom-24 bg-emerald-600 text-white px-4 py-2 rounded-full shadow-2xl font-bold text-xs uppercase tracking-widest border border-emerald-300/40">
        UPDATE
    </button>
    <!-- Determinatie modal -->
    <div id="det-modal" class="det-modal-backdrop hidden" onclick="closeDetModal(event)">
        <div class="det-modal-card relative space-y-3" onclick="event.stopPropagation();">
            <button class="absolute right-3 top-3 text-gray-400 text-lg" onclick="closeDetModal(event)">‚úï</button>
            <div id="det-modal-title" class="text-2xl font-extrabold text-white">Determinatie</div>
            <div id="det-modal-rarity" class="rarity-pill bg-emerald-900 text-emerald-200"></div>
            <div id="det-modal-links" class="space-y-2">
                <button id="det-modal-link" onclick="openDetLink('wiki')" class="w-full bg-emerald-900/40 text-emerald-100 border border-emerald-600/50 py-2 rounded text-sm hidden">Wikipedia zoekopdracht</button>
                <button id="det-modal-link-np" onclick="openDetLink('np')" class="w-full bg-blue-900/40 text-blue-100 border border-blue-600/50 py-2 rounded text-sm hidden">Natuurpunt soortfiche</button>
            </div>
            <div class="space-y-2 pt-2">
                <button id="det-modal-add" class="bg-emerald-600 text-white py-2 rounded-lg font-bold uppercase text-xs w-full" onclick="applyDeterminationToCounts(); closeDetModal();">Voeg toe aan teller</button>
                <button class="bg-gray-700 text-white py-2 rounded-lg font-bold uppercase text-xs w-full" onclick="closeDetModal()">Ok</button>
            </div>
        </div>
    </div>

    <!-- Photo lightbox -->
    <div id="photo-lightbox" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[200] flex items-center justify-center p-4" onclick="closePhoto(event)">
        <div class="relative max-w-4xl max-h-[90vh] w-full flex justify-center">
            <img id="photo-lightbox-img" src="" class="rounded-xl shadow-2xl max-h-[90vh] object-contain bg-black" alt="Foto">
            <button class="absolute top-2 right-2 bg-black/60 text-white rounded-full w-10 h-10 font-bold text-lg" onclick="closePhoto(event)">‚úï</button>
        </div>
    </div>

    <!-- QR scan modal -->
    <div id="qr-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-[210] flex items-center justify-center p-4" onclick="closeQrModal(event)">
        <div class="bg-gray-900 rounded-xl border border-purple-500/40 w-full max-w-md p-4 relative">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-purple-200 font-bold text-sm">QR Scan</h3>
                <button class="bg-black/50 text-white rounded-full w-8 h-8" onclick="closeQrModal(event)">‚úï</button>
            </div>
            <div id="session-reader-modal" class="rounded-lg overflow-hidden bg-black aspect-square"></div>
            <div class="text-[10px] text-gray-400 mt-2">Richt de camera op de QR-code.</div>
        </div>
    </div>

    <script>
        document.title = `Paddentrek Teller Pro ${APP_VERSION}`;
        document.getElementById('app-version-display').innerText = APP_VERSION;
        document.getElementById('pwa-status').onclick = () => alert('Groen bolletje = app volledig beschikbaar (ook offline). Rood = service worker fout, herlaad of check verbinding. Geel/grijs = bezig met laden of update.');

        // --- SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(`./sw.js?v=${APP_VERSION}`).then(reg => {
                document.getElementById('status-icon').className = 'status-dot bg-emerald-500 shadow-[0_0_8px_#10b981]';
                const st = document.getElementById('status-text');
                st.innerText = '';
                st.classList.add('hidden');

                // Luister naar nieuwe versies
                reg.addEventListener('updatefound', () => {
                    const u = reg.installing?.scriptURL || '';
                    const m = u.match(/v=([^&]+)/);
                    showUpdateBadge(m ? m[1] : null);
                });
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    const u = reg.active?.scriptURL || '';
                    const m = u.match(/v=([^&]+)/);
                    showUpdateBadge(m ? m[1] : null);
                });
            }).catch(() => {
                document.getElementById('status-icon').className = 'status-dot bg-red-500';
                const st = document.getElementById('status-text');
                st.innerText = 'SW fout';
                st.classList.remove('hidden');
            });

            navigator.serviceWorker.addEventListener('message', ev => {
                if(ev.data?.type === 'NEW_VERSION') showUpdateBadge(ev.data.version || APP_VERSION);
            });
        }

        // --- FX ---
        const canvas = document.getElementById('canvas-fx');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.size = Math.random() * 4 + 1.5;
                this.vX = (Math.random() - 0.5) * 12;
                this.vY = (Math.random() - 0.5) * 12;
                this.life = 1.2;
            }
            update() { this.x += this.vX; this.y += this.vY; this.vY += 0.2; this.life -= 0.02; }
            draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
        }

        class EmojiParticle extends Particle {
            constructor(x, y, emoji) {
                super(x, y, '#9ca3af');
                this.emoji = emoji;
                this.size = 18 + Math.random()*8;
            }
            draw() {
                ctx.save();
                ctx.font = `${this.size}px Arial`;
                ctx.globalAlpha = Math.max(this.life, 0);
                ctx.fillText(this.emoji, this.x, this.y);
                ctx.restore();
            }
        }

        class HeartParticle extends Particle {
            constructor(x, y, color) { super(x, y, color); this.size = Math.random() * 4 + 4; }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                const s = this.size;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.bezierCurveTo(this.x - s, this.y - s, this.x - 2*s, this.y + s*0.8, this.x, this.y + s*1.8);
                ctx.bezierCurveTo(this.x + 2*s, this.y + s*0.8, this.x + s, this.y - s, this.x, this.y);
                ctx.fill();
            }
        }

        function celebrate(e, hearts = false, sad = false, boost = 0) {
            const colors = hearts ? ['#fb7185', '#f472b6', '#ef4444', '#f87171']
                                  : sad ? ['#60a5fa', '#94a3b8', '#a5b4fc', '#22d3ee']
                                        : ['#10b981', '#60a5fa', '#fcd34d', '#f472b6', '#ffffff'];
            const x = e ? e.clientX : window.innerWidth / 2;
            const y = e ? e.clientY : window.innerHeight / 2;
            const base = hearts ? 50 : sad ? 25 : 60;
            const count = base + boost;
            const sadEmojis = ['‚ò†Ô∏è','üíÄ','ü•Ä','üò¢','ü™¶','üôÅ'];
            for(let i=0; i<count; i++) {
                const color = colors[Math.floor(Math.random()*colors.length)];
                if(hearts) particles.push(new HeartParticle(x, y, color));
                else if(sad) particles.push(new EmojiParticle(x, y, sadEmojis[Math.floor(Math.random()*sadEmojis.length)]));
                else particles.push(new Particle(x, y, color));
            }
            // extra confetti-golf
            setTimeout(()=> {
                for(let i=0;i<count/1.5;i++){
                    const color = colors[Math.floor(Math.random()*colors.length)];
                    particles.push(new Particle(x + (Math.random()-0.5)*200, y + (Math.random()-0.5)*200, color));
                }
            }, 350);
        }

        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        animate();

        // --- HAPTICS ---
        let lastVibeTs = 0;
        function vibe(ms = 15, force = false) {
            if(!navigator.vibrate) return;
            const now = Date.now();
            if(!force && now - lastVibeTs < 60) return;
            navigator.vibrate(ms);
            lastVibeTs = now;
        }
        document.addEventListener('pointerdown', ev => {
            const btn = ev.target.closest('button');
            if(btn && !btn.disabled) vibe();
        }, { passive: true });

        // --- DATA ---
        const SPECIES = [
            { id: 'pad', name: 'Gewone Pad', color: 'emerald', hasAmplexus: true },
            { id: 'br_kikker', name: 'Bruine Kikker', color: 'amber', hasAmplexus: true },
            { id: 'alpen', name: 'Alpenwatersalamander', color: 'blue', hasAmplexus: false },
            { id: 'kleine', name: 'Kleine Watersalamander', color: 'orange', hasAmplexus: false },
            { id: 'vin', name: 'Vinpootsalamander', color: 'pink', hasAmplexus: false },
            { id: 'kam', name: 'Kamsalamander', color: 'yellow', hasAmplexus: false }
        ];

        let detEditing = false;

        function rarityFor(speciesId) {
            const map = {
                vuurs: ['Zeldzaam','bg-yellow-900 text-yellow-200'],
                kam: ['Zeldzaam','bg-yellow-900 text-yellow-200'],
                vroed: ['Zeer zeldzaam','bg-red-900 text-red-200'],
                knoflook: ['Zeer zeldzaam','bg-red-900 text-red-200'],
                boomkikker: ['Zeer zeldzaam','bg-red-900 text-red-200'],
                rugstreep: ['Zeldzaam','bg-yellow-900 text-yellow-200'],
                heikikker: ['Zeldzaam','bg-yellow-900 text-yellow-200'],
                br_kikker: ['Algemeen','bg-emerald-900 text-emerald-200'],
                pad: ['Algemeen','bg-emerald-900 text-emerald-200'],
                alpen: ['Algemeen','bg-emerald-900 text-emerald-200'],
                vin: ['Algemeen','bg-emerald-900 text-emerald-200'],
                kleine: ['Algemeen','bg-emerald-900 text-emerald-200'],
                groene: ['Algemeen','bg-emerald-900 text-emerald-200'],
            };
            return map[speciesId] || ['Onbekend','bg-gray-800 text-gray-200'];
        }

        function cleanSpeciesName(n) { return n ? n.split('(')[0].trim() : ''; }
        function toSlug(n) {
            return cleanSpeciesName(n || '')
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

                // Beslisboom (geactualiseerd op basis van veldkaart)

        const DET_TREE = {
            id: 'root',
            question: 'Heeft het dier een staart?',
            yes: 'sal_start',
            no: 'frog_start'
        };
        const DET_NODES = {
            // Salamanders
            sal_start: { id:'sal_start', question:'Is het dier zwart en geel gekleurd?', yes:'res_vuurs', no:'sal_buik' },
            sal_buik: { id:'sal_buik', question:'Is de buik oranje en ongevlekt?', yes:'res_alpen', no:'sal_keel_ongevlekt' },
            sal_keel_ongevlekt: { id:'sal_keel_ongevlekt', question:'Is de keel ongevlekt?', yes:'res_vin', no:'sal_keel_spots' },
            sal_keel_spots: { id:'sal_keel_spots', question:'Is de keel donker met lichte spikkels?', yes:'res_kam', no:'res_kleine' },

            // Kikkers/padden
            frog_start: { id:'frog_start', question:'Heeft het dier een wrattige huid?', yes:'frog_wrata', no:'frog_pupil_vert' },
            frog_wrata: { id:'frog_wrata', question:'Heeft het dier een horizontale pupil?', yes:'frog_geelstreep', no:'res_vroed' },
            frog_geelstreep: { id:'frog_geelstreep', question:'Heeft het dier een gele rugstreep?', yes:'res_rugstreep', no:'res_pad' },

            frog_pupil_vert: { id:'frog_pupil_vert', question:'Heeft het dier een verticale pupil?', yes:'res_knoflook', no:'frog_masker' },
            frog_masker: { id:'frog_masker', question:'Is er een brede donkere vlek achter het oog (masker)?', yes:'frog_rug_tot_snuit', no:'frog_hechtschijf' },
            frog_rug_tot_snuit: { id:'frog_rug_tot_snuit', question:'Loopt er een lichte rugstreep tot aan de snuit?', yes:'res_heikikker', no:'res_bruine' },
            frog_hechtschijf: { id:'frog_hechtschijf', question:'Zijn er hechtschijfjes aan de tenen?', yes:'res_boomkikker', no:'res_groenekikker' },

            // Resultaten
            res_vuurs: { result:true, species:'vuurs', name:'Vuursalamander' },
            res_alpen: { result:true, species:'alpen', name:'Alpenwatersalamander' },
            res_vin: { result:true, species:'vin', name:'Vinpootsalamander' },
            res_kam: { result:true, species:'kam', name:'Kamsalamander' },
            res_kleine: { result:true, species:'kleine', name:'Kleine watersalamander' },

            res_vroed: { result:true, species:'vroed', name:'Vroedmeesterpad' },
            res_rugstreep: { result:true, species:'rugstreep', name:'Rugstreeppad' },
            res_pad: { result:true, species:'pad', name:'Gewone pad' },
            res_knoflook: { result:true, species:'knoflook', name:'Knoflookpad' },
            res_heikikker: { result:true, species:'heikikker', name:'Heikikker' },
            res_bruine: { result:true, species:'br_kikker', name:'Bruine kikker' },
            res_boomkikker: { result:true, species:'boomkikker', name:'Boomkikker' },
            res_groenekikker: { result:true, species:'groene', name:'Groene kikker' }
        };

        // helpers voor determinatie-rapporten
        function detQuestionText(nodeId) {
            if(nodeId === 'root') return DET_TREE.question;
            return DET_NODES[nodeId]?.question || nodeId;
        }
        function detAnswerLabel(ans) { return ans === 'yes' ? 'JA' : 'NEE'; }


        const WMO = { 0: "Helder", 1: "Licht bewolkt", 2:"Half bewolkt", 3: "Bewolkt", 61: "Regen", 80: "Buien" };

        const STORAGE_KEY = `paddentrek_${APP_VERSION}`;
        let reportMode = 'session'; // 'session' | 'day'
        let photoTargetSession = null;
        let viewedSessionId = '';
        let sessionScanner = null;
        let storage = JSON.parse(localStorage.getItem(STORAGE_KEY));
        let activeDeterminationId = null;
        let activeDeterminationSessionId = null;
        let detCredits = null;
        // Migreer indien versie is opgehoogd zodat data behouden blijft
        if(!storage) {
            const prevKey = Object.keys(localStorage)
                .filter(k => k.startsWith('paddentrek_') && k !== STORAGE_KEY)
                .sort()
                .pop();
            storage = prevKey ? (JSON.parse(localStorage.getItem(prevKey)) || {}) : {};
            localStorage.setItem(STORAGE_KEY, JSON.stringify(storage));
        }
        let activeSessionId = null;
        // Schema v2: per day stores counts, custom, photos, notes, weather, sessions
        // session object: { id, start, end?, counts: {}, notes: '' }
        let lastAction = null;
        const picker = document.getElementById('datePicker');

        // Gebruik lokale datum (niet UTC) zodat dag juist blijft rond middernacht en tijdzones
        const todayISO = () => {
            const now = new Date();
            const offsetMs = now.getTimezoneOffset() * 60000;
            const local = new Date(now.getTime() - offsetMs);
            return local.toISOString().split('T')[0];
        };

        function setDateInputsToToday() {
            const today = todayISO();
            picker.value = today;
            const sd = document.getElementById('sessionDate');
            if(sd) sd.value = today;
            const pd = document.getElementById('photo-clean-date');
            if(pd) pd.value = today;
        }

        setDateInputsToToday();

        // Zorgt dat een dag-object altijd alle sleutels heeft voordat we ermee werken
        function ensureDay(d = picker.value) {
            if(!storage[d]) storage[d] = { counts: {}, custom: [], photos: [], notes: "", sessions: [], weather: null };
            const day = storage[d];
            if(!day.counts) day.counts = {};
            if(!day.custom) day.custom = [];
            if(!day.photos) day.photos = [];
            if(typeof day.notes !== 'string') day.notes = "";
            if(!day.sessions) day.sessions = [];
            if(!day.weather) day.weather = null;
            day.sessions.forEach(s => {
                if(!s.counts) s.counts = {};
                if(!s.photos) s.photos = [];
                if(!s.determinations) s.determinations = [];
                if(!s.routeName) s.routeName = "";
                if(typeof s.notes !== 'string') s.notes = "";
                if(!s.weather) s.weather = null;
            });
            return day;
        }

        function findRunningSessionAcrossDays() {
            for(const d in storage) {
                const day = ensureDay(d);
                const sess = day.sessions.find(s => !s.end);
                if(sess) return { dayKey: d, session: sess };
            }
            return null;
        }

        function splitSessionOverMidnightIfNeeded() {
            const today = todayISO();
            const running = findRunningSessionAcrossDays();
            if(!running) return;
            if(running.dayKey === today) return;

            const prevDay = ensureDay(running.dayKey);
            const sess = prevDay.sessions.find(s => s.id === running.session.id);
            if(!sess) return;

            // sluit vorige dag af op 23:59
            const prevEnd = new Date(`${running.dayKey}T23:59:00`).toISOString();
            sess.end = prevEnd;
            recalcDayFromSessions(prevDay);

            // start nieuwe sessie op nieuwe dag, leeg zodat nieuwe tellingen correct landen
            const newDay = ensureDay(today);
            const newSession = { id: 'sess_'+Date.now(), start: new Date(`${today}T00:00:00`).toISOString(), counts: {}, notes: '', weather: null, photos: [], routeName: sess.routeName || '' };
            newDay.sessions.push(newSession);
            activeSessionId = newSession.id;
            viewedSessionId = newSession.id;
            setDateInputsToToday();
            save();
            showToast('Sessie gesplitst om middernacht');
        }

        function migrateOldSchema() {
            for(const d in storage) {
                const day = storage[d];
                if(!day.sessions) day.sessions = [];
                if(!day.custom) day.custom = [];
                if(!day.photos) day.photos = [];
                if(typeof day.notes !== 'string') day.notes = "";
                if(!day.weather) day.weather = null;
                day.sessions.forEach(s => {
                    if(!s.counts) s.counts = {};
                    if(!s.photos) s.photos = [];
                    if(!s.determinations) s.determinations = [];
                    if(!s.routeName) s.routeName = "";
                    if(typeof s.notes !== 'string') s.notes = "";
                    if(!s.weather) s.weather = null;
                });
            }
            save();
        }

        function buildUI() {
            document.getElementById('render-target').innerHTML = SPECIES.map(s => renderCard(s)).join('');
            renderCustom();
            renderSessionLog();
        }

        function renderCard(s, custom = false) {
            const liveKeys = s.hasAmplexus ? ['p_l','m_l','v_l','o_l'] : ['m_l','v_l','o_l'];
            return `
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg border-l-4 border-${s.color}-500 mb-6 transition-all">
                    <h2 class="text-sm font-bold mb-3 flex justify-between items-center text-white">
                        ${s.name} ${custom ? '<span class="text-[8px] opacity-40 italic">EXTRA</span>' : ''}
                        <span class="text-[9px] bg-black/40 px-2 py-1 rounded">TOT: <span id="tot-${s.id}" class="text-white font-bold">0</span></span>
                    </h2>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <p class="text-[8px] text-emerald-400 font-bold uppercase tracking-widest italic">Levend</p>
                                ${liveKeys.map(k => btn(s.id, k, s.color, k==='p_l' ? livePairLabel() : iconLabel(k, false))).join('')}
                            </div>
                            <div class="space-y-1">
                                <p class="text-[8px] text-red-500 font-bold uppercase tracking-widest italic">Dood</p>
                                ${s.hasAmplexus ? btn(s.id, 'p_d', 'red', deadPairLabel(), true) : ''}
                                ${['m_d','v_d','o_d'].map(k => btn(s.id, k, 'red', iconLabel(k, true), true)).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function livePairLabel() {
            return `<span class="inline-flex items-center gap-1 text-[15px] font-bold">
                <span class="icon-lg font-bold">M</span>
                <span class="icon-lg" style="color:#f87171;">‚ù§Ô∏è</span>
                <span class="icon-lg font-bold">V</span>
            </span>`;
        }
        function deadPairLabel() {
            return `<span class="inline-flex items-center gap-1">
                <span class="icon-lg">‚ò†Ô∏è</span>
                <span class="icon-lg font-bold">M</span>
                <span class="icon-lg" style="color:#f87171;">‚ù§Ô∏è</span>
                <span class="icon-lg font-bold">V</span>
            </span>`;
        }

        function iconLabel(key, dead = false) {
            const isM = key.startsWith('m') || key.includes('m_');
            const isV = key.startsWith('v') || key.includes('v_');
            const isO = key.startsWith('o') || key.includes('o_');
            const male = `<span class="icon-lg font-bold">M</span>`;
            const female = `<span class="icon-lg font-bold">V</span>`;
            const unk = `<span class="icon-lg font-bold">?</span>`;
            const skull = `<span class="icon-lg">‚ò†Ô∏è</span>`;
            if(isM) return dead ? `${skull}${male}` : `${male}`;
            if(isV) return dead ? `${skull}${female}` : `${female}`;
            if(isO) return dead ? `${skull}${unk}` : `${unk}`;
            return key;
        }

        function btn(sid, type, color, label, dood = false) {
            const key = `${sid}_${type}`;
            let cls = dood ? 'bg-red-950/40 border-red-900/40 text-red-300' : `bg-${color}-700 border-white/5 text-white shadow-sm`;
            if(color==='emerald' && type==='p_l') cls = 'bg-emerald-600 border-emerald-400/20';
            if(color==='amber') cls = dood ? 'bg-red-950/40' : 'bg-amber-700';
            if(color==='yellow') cls = dood ? 'bg-red-950/40' : 'bg-yellow-700';

            return `
                <div class="flex items-center gap-1">
                    <button onclick="mod('${key}', 1, event)" class="counter-btn flex-grow ${cls} h-10 rounded-lg font-bold text-[14px] border active:scale-95">
                        <span class="inline-flex items-center gap-1 align-middle">${label}</span>: <span id="${key}">0</span>
                    </button>
                    <button onclick="mod('${key}', -1, event)" class="minus-btn bg-gray-700/40 w-8 h-10 rounded-lg text-gray-500 border border-gray-600/20 active:bg-gray-600">-</button>
                </div>
            `;
        }

        function mod(key, val, e) {
            splitSessionOverMidnightIfNeeded();
            const d = picker.value;
            const day = ensureDay(d);
            let active = getActiveSession(day);
            if(!active) {
                startSession(true, false, d, false); // auto-start zonder redirect
                active = getActiveSession(day);
            }
            day.counts[key] = (day.counts[key] || 0) + val;
            if(day.counts[key] < 0) day.counts[key] = 0;
            // Also bump active session if running
            if(active) {
                active.counts[key] = (active.counts[key] || 0) + val;
                if(active.counts[key] < 0) active.counts[key] = 0;
            }
            save(); render();
            if(val > 0) {
                vibe(22, true);
                if(key.includes('_p_l')) celebrate(e, true);
                else if(key.includes('_l')) celebrate(e);
                else if(key.includes('_d')) celebrate(e, false, true);
            }
        }

        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(storage)); }

        // --- DEV STORAGE INSPECTOR ---
        function formatBytes(b) {
            if(!b || isNaN(b)) return '0 B';
            const u = ['B','KB','MB','GB'];
            const i = Math.min(Math.floor(Math.log(b)/Math.log(1024)), u.length-1);
            return `${(b/Math.pow(1024,i)).toFixed(1)} ${u[i]}`;
        }

        function renderStorageInspector(forceReload = false) {
            const box = document.getElementById('storage-inspector');
            const meta = document.getElementById('storage-meta');
            if(!box || !meta) return;
            const search = (document.getElementById('storage-search')?.value || '').toLowerCase();
            const keys = Object.keys(localStorage).sort();
            let totalBytes = 0;
            const rows = keys.map(k => {
                const raw = localStorage.getItem(k) || '';
                totalBytes += raw.length;
                let pretty = raw;
                let type = 'string';
                let imgs = [];
                try {
                    const parsed = JSON.parse(raw);
                    pretty = JSON.stringify(parsed, null, 2);
                    type = Array.isArray(parsed) ? 'array' : (parsed && typeof parsed === 'object' ? 'object' : typeof parsed);
                    // verzamel data:image... strings voor preview
                    const collect = v => {
                        if(typeof v === 'string' && v.startsWith('data:image')) imgs.push(v);
                        else if(Array.isArray(v)) v.forEach(collect);
                        else if(v && typeof v === 'object') Object.values(v).forEach(collect);
                    };
                    collect(parsed);
                } catch(_) { /* keep raw */ }
                const hay = `${k} ${pretty}`.toLowerCase();
                if(search && !hay.includes(search)) return null;
                const badge = k === STORAGE_KEY ? '<span class="text-[9px] bg-emerald-500/20 border border-emerald-400/30 text-emerald-100 px-2 py-1 rounded">actief</span>' : '';
                const imgHtml = imgs.map((src,idx) => `<button type="button" onclick="openInspectorPhoto('${idx}', '${k}')" class="block"><img src="${src}" alt="foto ${idx+1}" class="h-16 w-16 object-cover rounded border border-gray-700"></button>`).join('');
                return `<details class="bg-gray-900 border border-gray-800 rounded p-2">
                    <summary class="cursor-pointer flex justify-between items-center text-gray-200">${k} ${badge}<span class="text-[10px] text-gray-400">${type} ¬∑ ${formatBytes(raw.length)}</span></summary>
                    <pre class="mt-2 bg-black/40 rounded p-2 whitespace-pre-wrap text-[10px] text-gray-200">${pretty.replace(/</g,'&lt;')}</pre>
                    ${imgHtml ? `<div class="mt-2 flex gap-2 flex-wrap">${imgHtml}</div>` : ''}
                </details>`;
            }).filter(Boolean);
            box.innerHTML = rows.join('') || '<div class="text-gray-500 text-[11px]">Geen matches.</div>';
            meta.innerText = `${keys.length} keys ¬∑ ${formatBytes(totalBytes)} totaal opgeslagen`;
        }

        function render() {
            const d = ensureDay();
            const active = getActiveSession(d);
            const countsSource = active ? (active.counts || {}) : d.counts;
            const up = s => {
                let t = 0;
                ['p_l','p_d','m_l','v_l','o_l','m_d','v_d','o_d'].forEach(k => {
                    const v = countsSource[`${s.id}_${k}`] || 0;
                    if(document.getElementById(`${s.id}_${k}`)) document.getElementById(`${s.id}_${k}`).innerText = v;
                    t += (k==='p_l' || k==='p_d') ? v*2 : v;
                });
                if(document.getElementById(`tot-${s.id}`)) document.getElementById(`tot-${s.id}`).innerText = t;
            };
            SPECIES.forEach(up);
            (d.custom || []).forEach(up);
            renderSessions();
            renderSessionLog();
            updateReport(); updateWeather();
            renderDetSessionOptions(); renderDeterminationUI(); renderDeterminationList();
        }

        function renderSessionLog() {
            const box = document.getElementById('session-log-container');
            if(!box) return;
            const day = ensureDay();
            const sessions = day.sessions.slice().sort((a,b)=>new Date(a.start)-new Date(b.start));
            if(!sessions.length) { box.innerHTML = '<div class="text-gray-500 text-sm">Nog geen sessies vandaag.</div>'; return; }
            const selected = viewedSessionId || sessions[sessions.length-1].id;
            box.innerHTML = sessions
            .filter(s => s.id === selected)
            .map(s => {
                const total = sumCounts(s.counts);
                const weather = s.weather ? `${s.weather.t}¬∞C ‚Ä¢ ${WMO[s.weather.c] || 'OK'}` : 'Onbekend';
                const photos = s.photos || [];
                return `
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 space-y-3">
                        <div class="flex justify-between items-start gap-2">
                            <div>
                                <div class="text-xs text-gray-400">${fmtTime(s.start)} - ${s.end ? fmtTime(s.end) : 'lopend'}</div>
                                <div class="text-lg font-bold text-white">${total} stuks</div>
                            </div>
                            <button class="bg-purple-700 px-2 py-1 rounded text-[10px]" onclick="triggerPhoto('${s.id}')">üì∏</button>
                        </div>
                            <div class="space-y-2 text-left">
                                <label class="text-[10px] uppercase text-gray-400 font-bold">Traject</label>
                                <input value="${s.routeName || ''}" oninput="updateRoute('${s.id}', this.value)" class="w-full bg-gray-700 rounded px-2 py-2 text-sm text-white border border-gray-600" placeholder="Sint-Amandsstraat, Pittem" list="route-suggestions">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-[10px] uppercase text-gray-400 font-bold">Weer</div>
                                    <div class="text-sm text-gray-200">${weather}</div>
                                </div>
                                <button class="bg-yellow-600 text-white px-3 py-1 rounded text-[10px]" onclick="fetchWeather(picker.value, '${s.id}')">GPS Update</button>
                            </div>
                            <label class="text-[10px] uppercase text-gray-400 font-bold">Notities</label>
                            <textarea oninput="updateSessionNotes('${s.id}', this.value)" class="w-full bg-gray-700 border-none rounded p-3 text-sm h-20 text-white focus:ring-1 focus:ring-blue-500">${s.notes || ''}</textarea>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between text-[10px] text-gray-400">
                                <span>Foto's (${photos.length})</span>
                                <div class="flex gap-2">
                                    <button class="bg-purple-700 px-3 py-1 rounded text-white text-[10px]" onclick="triggerPhoto('${s.id}')">‚ûï Voeg foto</button>
                                    <button class="bg-purple-900/60 border border-purple-500 px-3 py-1 rounded text-white text-[10px]" onclick="shareSessionPhotos('${s.id}')">üì§ Deel</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                ${photos.map((p,i)=>`
                                    <div class="relative">
                                        <img src="${p}" class="rounded w-full aspect-square object-cover shadow cursor-pointer" onclick="openPhoto('${s.id}', ${i})">
                                        <button class="absolute top-1 right-1 bg-red-700 rounded-full w-5 h-5 text-[9px] font-bold" onclick="removeSessionPhoto('${s.id}', ${i})">X</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            buildRouteSuggestions();
        }

        // --- DETERMINATIE FLOW ---
        function getDetSession() {
            const day = ensureDay();
            if(activeDeterminationSessionId) {
                const sessByState = day.sessions.find(s => s.id === activeDeterminationSessionId);
                if(sessByState) return sessByState;
            }
            if(activeDeterminationId) {
                const sessByDet = findSessionByDeterminationId(activeDeterminationId, day);
                if(sessByDet) {
                    activeDeterminationSessionId = sessByDet.id;
                    return sessByDet;
                }
            }
            return getActiveSession(day) || getLatestSession(day) || null;
        }

        function renderDetSessionOptions() {
            const sel = document.getElementById('det-session-select');
            const label = document.getElementById('det-session-label');
            const btnStart = document.getElementById('det-start-session-btn');
            const btnLoose = document.getElementById('det-loose-btn');
            const btnNew = document.getElementById('det-new-btn');
            const day = ensureDay();
            if(!sel) return;
            const sessions = day.sessions.slice().sort((a,b)=>new Date(a.start)-new Date(b.start));
            sel.innerHTML = sessions.map(s => {
                const l = `${fmtTime(s.start)} ${s.end ? '‚Äì '+fmtTime(s.end) : '(live)'}`;
                return `<option value="${s.id}">${l}</option>`;
            }).join('') || '<option value=\"\">Geen sessies</option>';
            const sess = getDetSession();
            if(sess && !sess.determinations) sess.determinations = [];
            if(!sess) {
                activeDeterminationId = null;
                activeDeterminationSessionId = null;
            }
            if(sess) sel.value = sess.id;
            if(label) label.innerText = sess ? `${fmtTime(sess.start)} ${sess.end ? '‚Äì '+fmtTime(sess.end) : '(live)'}` : 'Geen sessie';
            const hasActive = !!getActiveSession(day);
            if(btnStart) btnStart.classList.add('hidden');
            if(btnLoose) btnLoose.classList.toggle('hidden', hasActive);
            if(btnNew) btnNew.classList.toggle('hidden', !hasActive);
        }

        function beginDetermination(id = null) {
            const day = ensureDay();
            let sess = null;
            if(id) {
                sess = findSessionByDeterminationId(id, day);
            } else {
                sess = getActiveSession(day);
                if(!sess) {
                    // Zonder actieve sessie: maak tijdelijke sessie voor losse determinatie.
                    startSession(true, false, picker.value, false, true);
                    sess = getActiveSession(ensureDay());
                }
            }
            if(!sess) { alert('Start eerst een sessie.'); return; }
            let det = null;
            detEditing = !!id;
            if(id) {
                det = sess.determinations.find(d => d.id === id);
            }
            if(!det) {
                det = { id:`det_${Date.now()}`, answers: [], photos: [], node:'root', result:null, resultName:'', createdAt:Date.now(), updatedAt:Date.now() };
                sess.determinations.push(det);
                detEditing = false;
            }
            activeDeterminationId = det.id;
            activeDeterminationSessionId = sess.id;
            save();
            renderDeterminationUI();
            renderDeterminationList();
        }

        function currentDetermination() {
            const sess = getDetSession();
            if(!sess || !activeDeterminationId) return null;
            return sess.determinations.find(d => d.id === activeDeterminationId) || null;
        }

        function triggerDetPhoto() {
            const det = currentDetermination();
            if(!det) { alert('Start eerst een determinatie.'); return; }
            if(det.photos.length >= 3) { alert('Max 3 foto‚Äôs.'); return; }
            const inp = document.getElementById('det-photo-input');
            if(inp) { inp.value=''; inp.click(); }
        }

        function handleDetPhoto(ev) {
            const file = ev.target.files?.[0];
            if(!file) return;
            const det = currentDetermination();
            const sess = getDetSession();
            
            if(!det || !sess) { alert('Geen actieve determinatie.'); return; }
            const reader = new FileReader();
            reader.onload = r => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas'); const m = 700;
                    const fct = Math.min(1, m/Math.max(img.width, img.height));
                    c.width = img.width*fct; c.height = img.height*fct;
                    c.getContext('2d').drawImage(img,0,0,c.width,c.height);
                    const data = c.toDataURL('image/jpeg', 0.7);
                    det.photos.push(data);
                    // ook toevoegen aan sessie-foto's zodat delen werkt
                    sess.photos.push(data);
                    save();
                    renderDeterminationUI();
                    renderDeterminationList();
                };
                img.src = r.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeDetPhoto(idx) {
            const det = currentDetermination();
            if(!det) return;
            det.photos.splice(idx,1);
            save();
            renderDeterminationUI();
            renderDeterminationList();
        }

        
        function goBackDetermination() {
            const det = currentDetermination();
            if(!det || !det.answers.length) return;
            det.answers.pop();
            const last = det.answers[det.answers.length-1];
            det.node = last ? last.node : 'root';
            det.result = null; det.resultName=''; det.completedAt=null; det.wikiThumb=null;
            save(); renderDeterminationUI(); renderDeterminationList();
        }

function answerDetermination(ans) {
            const det = currentDetermination();
            if(!det) { alert('Start eerst een determinatie.'); return; }
            const nodeId = det.node || 'root';
            const node = nodeId === 'root' ? DET_TREE : DET_NODES[nodeId];
            if(!node) return;
            det.answers.push({ node: nodeId, answer: ans });
            let next = null;
            if(node.result) {
                next = node;
            } else {
                const jump = ans === 'yes' ? node.yes : node.no;
                next = DET_NODES[jump] || DET_NODES[DET_TREE[jump]] || DET_NODES[jump];
                det.node = jump;
            }
            det.updatedAt = Date.now();
            // check result
            const n = node.result ? node : (DET_NODES[det.node] && DET_NODES[det.node].result ? DET_NODES[det.node] : null);
            if(n && n.result) {
                det.result = n.species;
                det.resultName = n.name;
                // sluit tijdelijke determinatie-sessie automatisch af na resultaat
                const sess = getDetSession();
                if(sess?.detTemp && !sess.end) {
                    const endIso = new Date(new Date(sess.start).getTime() + 60000).toISOString();
                    sess.end = endIso;
                    if(activeSessionId === sess.id) activeSessionId = null;
                    render(); // refresh UI (record knop / nieuwe sessie knop)
                }
                if(!det.completedAt) {
                    det.completedAt = Date.now();
                    celebrate(null, true, false, 80);
                    showToast(`Determinatie: ${det.resultName}`);
                    if(!det.wikiThumb) {
                    const name = cleanSpeciesName(det.resultName || det.result);
                    det.wikiThumb = null;
                    det.wikiLink = `https://nl.wikipedia.org/w/index.php?search=${encodeURIComponent(name)}`;
                    save();
                    }
                    showDetModal(det);
                }
            }
            save();
            renderDeterminationUI();
            renderDeterminationList();
        }

        function resetDetermination(id) {
            const det = currentDetermination();
            if(!det) return;
            det.answers = [];
            det.node = 'root';
            det.result = null;
            det.resultName = '';
            det.updatedAt = Date.now();
            save(); renderDeterminationUI(); renderDeterminationList();
        }

        function renderDeterminationUI() {
            const det = currentDetermination();
            const qBox = document.getElementById('det-question');
            const resBox = document.getElementById('det-result');
            const applyBox = document.getElementById('det-apply');
            const warnBox = document.getElementById('det-warning');
            const progress = document.getElementById('det-progress');
            const btnY = document.getElementById('det-btn-yes');
            const btnN = document.getElementById('det-btn-no');
            const btnBack = document.getElementById('det-btn-back');
            const btnReset = document.getElementById('det-btn-reset');
            const strip = document.getElementById('det-photo-strip');
            const qCard = document.getElementById('det-question-card');
            renderDetSessionOptions();
            if(strip) {
                strip.innerHTML = det ? det.photos.map((p,i)=>`
                    <div class="relative">
                        <img src="${p}" class="rounded-lg w-full aspect-square object-cover cursor-pointer" onclick="openDetPhoto('${det.id}', ${i})">
                        <button class="absolute top-1 right-1 bg-black/60 text-white rounded-full w-6 h-6 text-[10px]" onclick="removeDetPhoto(${i})">‚úï</button>
                    </div>
                `).join('') : '<div class="text-gray-500 text-[11px]">Nog geen foto\'s.</div>';
            }
            if(!det || !qBox) {
                if(qBox) qBox.innerText = 'Start een nieuwe determinatie om vragen te krijgen.';
                if(resBox) resBox.innerText = '';
                if(progress) progress.innerText = '';
                if(applyBox) applyBox.classList.add('hidden');
                if(warnBox) warnBox.classList.add('hidden');
                if(btnBack) btnBack.disabled = true;
                if(btnReset) btnReset.classList.add('hidden');
                if(qCard) qCard.classList.add('hidden');
                [btnY, btnN].forEach(b => b && (b.disabled = true));
                return;
            }
            if(qCard) qCard.classList.remove('hidden');
            const nodeId = det.node || 'root';
            const node = nodeId === 'root' ? DET_TREE : DET_NODES[nodeId];
            const atResult = node && node.result;
            if(qBox) qBox.innerText = atResult ? 'Determinatie afgerond' : (node?.question || 'Vraag onbekend');
            if(resBox) {
                resBox.innerHTML = det.resultName
                    ? `<div class="det-result-banner">Determinatie: ${det.resultName}</div>`
                    : '';
            }
            const thumbBox = document.getElementById('det-thumb-box');
            const thumbImg = document.getElementById('det-thumb-img');
            const thumbCap = document.getElementById('det-thumb-cap');
            if(thumbBox && thumbImg) {
                thumbBox.classList.add('hidden'); // geen afbeeldingen meer tonen
            }
            if(progress) progress.innerText = `Vragen beantwoord: ${det.answers.length}`;
            if(btnBack) btnBack.disabled = det.answers.length === 0;
            if(btnReset) btnReset.classList.toggle('hidden', det.answers.length === 0);
            if(applyBox) applyBox.classList.toggle('hidden', !det.result);
            if(warnBox) warnBox.classList.toggle('hidden', !(detEditing && det.result));
            [btnY, btnN].forEach(b => b && (b.disabled = !!det.result));
            // hintBox niet meer gebruikt; blijft verborgen
        }

        function renderDeterminationList() {
            const list = document.getElementById('det-list');
            if(!list) return;
            const sess = getDetSession();
            
            if(!sess || !sess.determinations?.length) {
                list.innerHTML = '<div class=\"text-gray-500\">Nog geen determinaties.</div>';
                return;
            }
            const sorted = sess.determinations.slice().sort((a,b)=>b.updatedAt - a.updatedAt);
            const items = [];
            sorted.forEach(d => {
                const photos = d.photos?.length || 0;
                const res = d.resultName || 'Onbekend';
                const ts = new Date(d.updatedAt).toLocaleString('nl-BE');
                const openBtn = `<button class="bg-blue-700 text-white px-2 py-1 rounded text-[10px]" onclick="openDetermination('${d.id}')">Open</button>`;
                const editBtn = `<button class="bg-gray-700 text-white px-2 py-1 rounded text-[10px]" onclick="beginDetermination('${d.id}')">Bewerk</button>`;
                items.push(
                    '<div class=\"bg-gray-900 border border-gray-700 rounded p-3 flex items-center justify-between gap-2\">' +
                        '<div>' +
                            `<div class=\"font-bold text-white\">${res}</div>` +
                            `<div class=\"text-gray-400 text-[10px]\">${ts} ¬∑ ${d.answers.length} vragen ¬∑ ${photos} foto(s)</div>` +
                        '</div>' +
                        '<div class=\"flex gap-2\">' + openBtn + editBtn + '</div>' +
                    '</div>'
                );
            });
            list.innerHTML = items.join('');
        }

        

        function startLooseDetermination() {
            // start een tijdelijke sessie enkel voor determinatie
            const day = ensureDay();
            if(!getActiveSession(day)) startSession(true, false, picker.value, false, true);
            beginDetermination();
            renderDetSessionOptions();
        }
function openDetermination(id) {
            activeDeterminationId = id;
            const sess = findSessionByDeterminationId(id, ensureDay());
            activeDeterminationSessionId = sess ? sess.id : null;
            detEditing = true;
            renderDeterminationUI();
            renderDeterminationList();
        }

        function applyDeterminationToCounts() {
            const det = currentDetermination();
            const day = ensureDay();
            const sess = getDetSession();
            if(!det || !det.result || !sess) return;
            const speciesId = det.result;
            const targetId = ensureSpeciesExists(speciesId, det.resultName || speciesId, day);
            const key = `${targetId}_o_l`;
            const inc = confirm(`'${det.resultName}' toevoegen aan teller?`) ? 1 : 0;
            if(!inc) return;
            day.counts[key] = (day.counts[key]||0) + 1;
            sess.counts[key] = (sess.counts[key]||0) + 1;
            save(); render(); showToast('Determinatie toegevoegd aan teller');
        }

        function ensureSpeciesExists(id, name, day) {
            if(SPECIES.some(s => s.id === id)) return id;
            const existing = (day.custom || []).find(c => c.name === name || c.id === id);
            if(existing) return existing.id;
            const obj = { id: id.startsWith('c_') ? id : `c_${id}`, name, color: 'gray', hasAmplexus: false };
            day.custom.push(obj);
            buildUI();
            return obj.id;
        }

        function renderSessions() {
            const day = ensureDay();
            const active = getActiveSession(day);
            const dayTotal = sumCounts(day.counts);
            const activeTotal = active ? sumCounts(active.counts) : null;
            const newBtn = document.getElementById('new-session-btn');
            if(newBtn) newBtn.classList.toggle('hidden', !!active);
            const camFab = document.getElementById('camera-fab');
            if(camFab) camFab.classList.toggle('hidden', !active);
            const recBtn = document.getElementById('record-btn');
            if(recBtn) recBtn.classList.toggle('hidden', !active);
            buildViewedSessionOptions();
            buildRouteSuggestions();
        }

        function buildViewedSessionOptions() {
            const sels = ['session-view-select','session-log-select'].map(id => document.getElementById(id)).filter(Boolean);
            if(!sels.length) return;
            const day = ensureDay();
            const sessions = day.sessions.slice().sort((a,b)=>new Date(a.start)-new Date(b.start));
            const opts = sessions.map(s => {
                const label = `${fmtTime(s.start)} ${s.end ? '‚Äì '+fmtTime(s.end) : '(live)'}`;
                return `<option value="${s.id}" ${s.id === (viewedSessionId || '') ? 'selected' : ''}>${label}</option>`;
            }).join('') || '<option value=\"\">Geen sessies</option>';
            sels.forEach(sel => {
                sel.innerHTML = opts;
                if(!viewedSessionId && sessions.length) viewedSessionId = sessions[sessions.length-1].id;
                if(sel && viewedSessionId) sel.value = viewedSessionId;
            });
        }

        function setViewedSession(id) {
            viewedSessionId = id || '';
            renderSessionLog();
            updateReport();
        }


        function updateSessionNotes(id, val) {
            const day = ensureDay();
            const s = day.sessions.find(x => x.id === id);
            if(!s) return;
            s.notes = val;
            save();
        }

        function updateRoute(id, val) {
            const day = ensureDay();
            const s = day.sessions.find(x => x.id === id);
            if(!s) return;
            s.routeName = val;
            save();
            buildRouteSuggestions();
        }

        function removeSessionPhoto(id, idx) {
            const day = ensureDay();
            const s = day.sessions.find(x => x.id === id);
            if(!s) return;
            s.photos.splice(idx,1);
            // dagbuffer opschonen grof (herstelt duplicaten niet exact, maar voldoende)
            day.photos = day.sessions.flatMap(ss => ss.photos);
            save(); renderSessionLog();
        }

        function openPhoto(sessionId, idx) {
            const day = ensureDay();
            let photo = null;
            if(sessionId === 'det') {
                const det = currentDetermination();
                photo = det?.photos?.[idx];
            } else {
                const s = day.sessions.find(x => x.id === sessionId);
                if(!s) return;
                photo = s.photos?.[idx];
            }
            if(!photo) return;
            const box = document.getElementById('photo-lightbox');
            const img = document.getElementById('photo-lightbox-img');
            img.src = photo;
            box.classList.remove('hidden');
        }

        // open foto uit storage inspector
        function openInspectorPhoto(idx, key) {
            const raw = localStorage.getItem(key || STORAGE_KEY);
            if(!raw) return;
            try {
                const parsed = JSON.parse(raw);
                const imgs = [];
                const collect = v => {
                    if(typeof v === 'string' && v.startsWith('data:image')) imgs.push(v);
                    else if(Array.isArray(v)) v.forEach(collect);
                    else if(v && typeof v === 'object') Object.values(v).forEach(collect);
                };
                collect(parsed);
                const photo = imgs[idx];
                if(!photo) return;
                const box = document.getElementById('photo-lightbox');
                const img = document.getElementById('photo-lightbox-img');
                img.src = photo;
                box.classList.remove('hidden');
            } catch(e) { console.log(e); }
        }


        function openDetPhoto(detId, idx) {
            const day = ensureDay();
            for(const s of day.sessions || []) {
                const det = (s.determinations || []).find(d => d.id === detId);
                if(det) {
                    const photo = det.photos?.[idx];
                    if(photo) {
                        const box = document.getElementById('photo-lightbox');
                        const img = document.getElementById('photo-lightbox-img');
                        img.src = photo;
                        box.classList.remove('hidden');
                    }
                    return;
                }
            }
        }

        function closePhoto(ev) {
            // close when backdrop or X clicked
            const box = document.getElementById('photo-lightbox');
            if(!box) return;
            if(ev.target.id === 'photo-lightbox' || ev.target.tagName === 'BUTTON' || ev.target.tagName === 'IMG' && ev.target.id === 'photo-lightbox-img') {
                box.classList.add('hidden');
                document.getElementById('photo-lightbox-img').src = '';
            }
        }

        function sumCounts(obj = {}) {
            let total = 0;
            for(const k in obj) {
                const v = obj[k] || 0;
                total += (k.includes('_p_')) ? v*2 : v; // paartjes tellen als twee dieren
            }
            return total;
        }

        function getActiveSession(day) {
            const running = (day.sessions || [])
                .filter(s => !s.end)
                .sort((a,b)=>new Date(b.start) - new Date(a.start));
            return running[0] || null;
        }

        function getLatestSession(day) {
            const sessions = (day.sessions || []).slice()
                .sort((a,b)=>new Date(b.start) - new Date(a.start));
            return sessions[0] || null;
        }

        function findSessionByDeterminationId(detId, day = ensureDay()) {
            if(!detId) return null;
            return (day.sessions || []).find(s => (s.determinations || []).some(d => d.id === detId)) || null;
        }

        function renderSessionAdmin() {
            const dayKey = document.getElementById('sessionDate')?.value || picker.value;
            const day = ensureDay(dayKey);
            const box = document.getElementById('session-admin-list');
            if(!box) return;
            const items = day.sessions.slice().sort((a,b)=>new Date(a.start)-new Date(b.start)).map(s => {
                const total = sumCounts(s.counts);
                const weather = s.weather ? `<div class="text-[10px] text-sky-300">üå§Ô∏è ${s.weather.t}¬∞C ${WMO[s.weather.c]||'OK'}</div>` : '';
                return `<label class="bg-gray-900 p-3 rounded border border-gray-800 flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" class="session-merge-checkbox accent-emerald-500" value="${s.id}">
                    <div class="flex-1">
                        <div class="font-bold text-gray-100">${fmtTime(s.start)} - ${s.end ? fmtTime(s.end) : 'lopend'}</div>
                        <div class="text-gray-400 text-[10px]">${total} stuks</div>
                        ${weather}
                    </div>
                    <button class="bg-red-700 px-2 py-1 rounded text-[12px]" onclick="deleteSession('${s.id}','${dayKey}')" title="Verwijder sessie">üóëÔ∏è</button>
                </label>`;
            }).join('') || '<div class="text-gray-500">Geen sessies voor deze dag.</div>';
            box.innerHTML = items;
            // merge action button
            const mergeBtn = document.createElement('button');
            mergeBtn.innerText = 'Merge selectie';
            mergeBtn.className = 'w-full bg-gray-700 mt-2 py-2 rounded text-[11px] font-bold';
            mergeBtn.onclick = () => mergeSelectedSessions(dayKey);
            box.appendChild(mergeBtn);
        }

        function startSession(force = false, fromSessionPage = false, dayKeyOverride = null, redirect = true, tempDet = false) {
            const dayKey = dayKeyOverride || (fromSessionPage ? (document.getElementById('sessionDate').value || picker.value) : picker.value);
            const day = ensureDay(dayKey);
            const existing = day.sessions.find(s => !s.end);
            if(existing && !force) { alert('Er draait al een sessie. Stop eerst.'); return; }
            const now = new Date();
            const session = { id: 'sess_'+now.getTime(), start: now.toISOString(), counts: {}, notes: tempDet ? 'Losse determinatie' : '', weather: null, photos: [], routeName: '', determinations: [], detTemp: tempDet };
            day.sessions.push(session);
            activeSessionId = session.id;
            viewedSessionId = session.id;
            save(); render(); renderSessionAdmin(); renderDetSessionOptions(); renderDeterminationUI(); renderDeterminationList(); showToast('Sessie gestart');
            if(redirect) switchTab('sessions');
            fetchWeather(dayKey, session.id); // capture weather at start
        }

        function endSession() {
            const day = ensureDay();
            const active = day.sessions.find(s => !s.end);
            if(!active) return alert('Geen actieve sessie');
            active.end = new Date().toISOString();
            save(); render(); renderSessionAdmin(); showToast('Sessie gestopt');
        }

        // legacy single merge fallback (unused in UI now but kept for safety)
        function mergeSession(id, dayKey = picker.value) {
            const day = ensureDay(dayKey);
            const target = day.sessions.find(s => s.id === id);
            if(!target) return;
            const others = day.sessions.filter(s => s.id !== id);
            if(!others.length) { alert('Minstens 2 sessies nodig.'); return; }
            const master = target;
            others.forEach(s => {
                for(const k in s.counts) master.counts[k] = (master.counts[k]||0) + s.counts[k];
                if(s.photos && s.photos.length) {
                    master.photos = (master.photos || []).concat(s.photos);
                }
                if(new Date(s.start) < new Date(master.start)) master.start = s.start;
                if(s.end && (!master.end || new Date(s.end) > new Date(master.end))) master.end = s.end;
                if(s.weather && !master.weather) master.weather = s.weather;
            });
            day.sessions = [master];
            recalcDayFromSessions(day);
            save(); render(); renderSessionAdmin(); showToast('Sessies samengevoegd');
        }

        function mergeSelectedSessions(dayKey = picker.value) {
            const day = ensureDay(dayKey);
            const boxes = Array.from(document.querySelectorAll('.session-merge-checkbox')).filter(cb => cb.checked);
            if(boxes.length < 2) { alert('Selecteer minstens 2 sessies.'); return; }
            const ids = boxes.map(b => b.value);
            const masterId = ids[0];
            const master = day.sessions.find(s => s.id === masterId);
            const others = day.sessions.filter(s => ids.includes(s.id) && s.id !== masterId);
            others.forEach(s => {
                for(const k in s.counts) master.counts[k] = (master.counts[k]||0) + s.counts[k];
                if(s.photos && s.photos.length) {
                    master.photos = (master.photos || []).concat(s.photos);
                }
                if(new Date(s.start) < new Date(master.start)) master.start = s.start;
                if(s.end && (!master.end || new Date(s.end) > new Date(master.end))) master.end = s.end;
                if(s.weather && !master.weather) master.weather = s.weather;
            });
            day.sessions = day.sessions.filter(s => !others.includes(s));
            recalcDayFromSessions(day);
            save(); render(); renderSessionAdmin(); showToast('Sessies samengevoegd');
        }

        function recalcDayFromSessions(day) {
            day.counts = {};
            day.sessions.forEach(s => {
                for(const k in s.counts) day.counts[k] = (day.counts[k]||0) + s.counts[k];
            });
            day.photos = day.sessions.flatMap(s => s.photos || []);
        }

        function purgeEmptyCustomSpecies() {
            for(const d in storage) {
                const day = ensureDay(d);
                if(!day.custom) continue;
                day.custom = day.custom.filter(c => {
                    const hasCounts = Object.keys(day.counts||{}).some(k => k.startsWith(`${c.id}_`) && (day.counts[k]||0) > 0);
                    return hasCounts || c.name !== 'Onbekend';
                });
                // verwijder lege count keys voor niet-bestaande custom soorten
                const validIds = new Set(day.custom.map(c => c.id));
                Object.keys(day.counts||{}).forEach(k => {
                    const sid = k.split('_')[0];
                    if(!validIds.has(sid) && k.startsWith('c_')) delete day.counts[k];
                });
            }
        }

        function deleteSession(id, dayKey = picker.value) {
            const day = ensureDay(dayKey);
            day.sessions = day.sessions.filter(s => s.id !== id);
            recalcDayFromSessions(day);
            if(activeSessionId === id) activeSessionId = null;
            save(); render(); renderSessionAdmin(); showToast('Sessie verwijderd');
        }

        function confirmMerge(id) {
            return confirm(`Sessies samenvoegen met ${id}?`);
        }

        function fmtTime(iso) {
            const d = new Date(iso);
            return d.toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });
        }

        async function fetchWeather(dayOverride, sessionId) {
            if(!navigator.geolocation) return;
            showToast("GPS zoekt...");
            navigator.geolocation.getCurrentPosition(async p => {
                try {
                    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`);
                    const j = await r.json();
                    const dayKey = dayOverride || picker.value;
                    const day = ensureDay(dayKey);
                    const w = { t: j.current_weather.temperature, c: j.current_weather.weathercode, ts: Date.now() };
                    day.weather = w;
                    if(sessionId) {
                        const sess = day.sessions.find(s => s.id === sessionId);
                        if(sess) sess.weather = w;
                    } else {
                        const active = day.sessions.find(s => !s.end);
                        if(active) active.weather = active.weather || w;
                    }
                    save(); render(); showToast("Weer OK");
                } catch(e) { alert("API Fout"); console.log(e) }
            });
        }

        function updateWeather() {
            const el = document.getElementById('weather-display');
            if(!el) return;
            const w = storage[picker.value]?.weather;
            el.innerText = w ? `${w.t}¬∞C - ${WMO[w.c] || "OK"}` : "Geen weerdata bekend.";
        }

        function addCustomSpecies() {
            const n = document.getElementById('new-species-name').value.trim();
            if(!n) return;
            const day = ensureDay();
            day.custom.push({ id: 'c_'+Date.now(), name: n, color: 'gray', hasAmplexus: true });
            document.getElementById('new-species-name').value = '';
            save(); buildUI(); render();
        }

        function renderCustom() {
            const d = ensureDay();
            document.getElementById('custom-species-render').innerHTML = d.custom.map(s => renderCard(s, true)).join('');
            document.getElementById('custom-species-list').innerHTML = d.custom.map(s => `
                <div class="flex justify-between items-center bg-gray-800 p-2 rounded text-[10px] mb-1 border border-gray-700 shadow-sm uppercase font-bold">
                    <span>${s.name}</span> <button onclick="removeC('${s.id}')" class="text-red-400 px-3 py-1 bg-red-900/20 rounded">Verwijder</button>
                </div>
            `).join('');
        }
        function removeC(id) { if(confirm("Soort wissen?")) { const day = ensureDay(); day.custom = day.custom.filter(c => c.id!==id); save(); buildUI(); render(); } }

        function triggerPhoto(sessionId = null) {
            const day = ensureDay();
            const target = sessionId || (getActiveSession(day)?.id || null);
            if(!target) { alert('Start eerst een sessie om foto\'s toe te voegen.'); return; }
            photoTargetSession = target;
            vibe(25, true);
            const input = document.getElementById('photo-input');
            input.value = '';
            input.click();
        }

        function handlePhoto(e) {
            const f = e.target.files[0]; if(!f) return;
            const day = ensureDay();
            const session = photoTargetSession
                ? day.sessions.find(s => s.id === photoTargetSession)
                : getActiveSession(day);
            if(!session) { alert('Geen actieve sessie gevonden.'); return; }
            const r = new FileReader(); r.onload = ev => {
                const img = new Image(); img.onload = () => {
                    const c = document.createElement('canvas'); const m = 600;
                    const fct = Math.min(1, m/Math.max(img.width, img.height));
                    c.width = img.width*fct; c.height = img.height*fct;
                    c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                    const data = c.toDataURL('image/jpeg', 0.6);
                    session.photos.push(data);
                    // ook op dag-niveau voor aggregatie en legacy
                    day.photos.push(data);
                    save(); renderSessionLog();
                }; img.src = ev.target.result;
            }; r.readAsDataURL(f);
        }

        function clearAllPhotos(dayKey = null) {
            if(!confirm(dayKey ? `Alle foto\'s van ${dayKey} wissen?` : 'Alle foto\'s in alle dagen wissen?')) return;
            if(dayKey) {
                const d = ensureDay(dayKey);
                d.photos = [];
                d.sessions.forEach(s => s.photos = []);
            } else {
                for(const d in storage) { const day = ensureDay(d); day.photos = []; day.sessions.forEach(s => s.photos = []); }
            }
            save(); renderSessionLog(); showToast('Foto\'s gewist');
        }

        async function shareSessionPhotos(sessionId) {
            const day = ensureDay();
            const session = day.sessions.find(s => s.id === sessionId);
            if(!session) return alert('Sessies niet gevonden');
            const photos = session.photos || [];
            if(!photos.length) return alert('Geen foto\'s in deze sessie.');
            const files = photos.map((dataUrl, idx) => {
                const res = dataURLToBlob(dataUrl);
                return new File([res.blob], `paddentrek-${picker.value}-${sessionId}-${idx+1}.${res.ext}`, { type: res.blob.type });
            });
            const text = `Foto's ${picker.value} (${fmtTime(session.start)}): ${photos.length} stuks`;
            const shareData = { title: 'Paddentrek', text, files };
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                    return;
                }
            } catch(err) {
                if(err?.name === 'AbortError') return;
            }
            const wa = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(wa, '_blank');
        }

        function dataURLToBlob(dataUrl) {
            const [meta, b64] = dataUrl.split(',');
            const mime = meta.match(/data:(.*);base64/)[1] || 'image/jpeg';
            const ext = mime.split('/')[1] || 'jpg';
            const bin = atob(b64);
            const arr = new Uint8Array(bin.length);
            for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
            return { blob: new Blob([arr], { type: mime }), ext };
        }

        function updateReport() {
            const d = picker.value; const data = ensureDay(d);
            const sel = document.getElementById('report-session-select');
            const sessionId = sel ? sel.value : '';
            const session = sessionId ? (data.sessions || []).find(s => s.id === sessionId) : null;
            const targetCounts = reportMode === 'session' && session ? session.counts : data.counts;
            let txt = `üê∏ *OVERZET-UPDATE - ${d}*\n\n`;
            const w = (reportMode === 'session' ? session?.weather : data.weather) || session?.weather;
            if(w) txt += `üå§Ô∏è *Weer:* ${w.t}¬∞C, ${WMO[w.c] || "OK"}\n\n`;
            const all = [...SPECIES, ...(data.custom || [])]; let h = false;
            all.forEach(s => {
                const pl = targetCounts[`${s.id}_p_l`]||0, pd = targetCounts[`${s.id}_p_d`]||0;
                const ml = targetCounts[`${s.id}_m_l`]||0, vl = targetCounts[`${s.id}_v_l`]||0, ol = targetCounts[`${s.id}_o_l`]||0;
                const md = targetCounts[`${s.id}_m_d`]||0, vd = targetCounts[`${s.id}_v_d`]||0, od = targetCounts[`${s.id}_o_d`]||0;
                if(pl+pd+ml+vl+ol+md+vd+od > 0) { h = true;
                    txt += `*${s.name}:*\n${pl>0 ? '  ‚ù§Ô∏è '+pl+' Koppels (levend)\n':''}${pd>0 ? '  ‚ò†Ô∏è '+pd+' Koppels (dood)\n':''}  - Levend: ${ml}m, ${vl}v, ${ol}o\n  - Dood: ${md}m, ${vd}v, ${od}o\n`;
                }
            });
            txt += `\n‚ÑπÔ∏è Koppels (‚ù§Ô∏è/‚ò†Ô∏è) worden niet dubbel geteld bij de losse man/vrouw-aantallen.\n`;
            if(reportMode === 'session' && session?.notes) txt += `\nüìù *Nota:* ${session.notes}\n`;
            if(reportMode === 'day' && data.notes) txt += `\nüìù *Nota:* ${data.notes}\n`;
            const sessionsToShow = reportMode === 'session' && session ? [session] : (data.sessions || []);
            if(sessionsToShow.length) {
                txt += `\n‚è±Ô∏è *Sessies:*\n`;
                sessionsToShow.sort((a,b)=>new Date(a.start)-new Date(b.start)).forEach(s => {
                    const total = sumCounts(s.counts);
                    const wtxt = s.weather ? ` | üå§Ô∏è ${s.weather.t}¬∞C ${WMO[s.weather.c]||'OK'}` : '';
                    const route = s.routeName ? ` | üö∂‚Äç‚ôÇÔ∏è ${s.routeName}` : '';
                    txt += `  - ${fmtTime(s.start)} - ${s.end ? fmtTime(s.end) : 'lopend'}: ${total} stuks${route}${wtxt}\n`;
                });
            }
            txt += `\n#Paddentrek #Telling`;
            document.getElementById('report-text').innerText = h || data.notes ? txt : "Nog geen data ingevoerd.";

            // determinaties blok
            const detBox = document.getElementById('report-dets');
            if(detBox) {
                const dets = (reportMode === 'session' && session)
                    ? (session.determinations || [])
                    : (data.sessions || []).flatMap(s => s.determinations || []);
                if(!dets.length) {
                    detBox.innerHTML = '<div class=\"text-gray-500\">Geen determinaties in deze selectie.</div>';
                } else {
                    const parts = [];
                    dets.slice().sort((a,b)=>b.updatedAt-a.updatedAt).forEach(det => {
                        const photos = det.photos?.length || 0;
                        const label = det.resultName || 'Onbekend';
                        const answers = det.answers || [];
                        const ts = new Date(det.updatedAt).toLocaleString('nl-BE');
                        const wiki = det.wikiThumb ? `<img src="${det.wikiThumb}" class="h-16 w-16 object-cover rounded-lg border border-gray-700 shadow" alt="${label}">` : '';
                        const ansBadges = answers.map((a,idx) =>
                            `<span class="px-2 py-1 rounded-full text-[10px] font-bold ${a.answer==='yes' ? 'bg-emerald-900/60 text-emerald-200' : 'bg-red-900/60 text-red-200'}">${idx+1}. ${detAnswerLabel(a.answer)}</span>`
                        ).join(' ');
                        const ansList = answers.map((a,idx) => `<div class="text-[11px] flex gap-2"><span class="text-gray-500">${idx+1}.</span><span class="flex-1 text-gray-200">${detQuestionText(a.node)}</span><span class="font-bold ${a.answer==='yes' ? 'text-emerald-400' : 'text-red-400'}">${detAnswerLabel(a.answer)}</span></div>`).join('');
                        const photoList = photos
                            ? det.photos.map((p,i)=>`<div class="relative"><img src="${p}" class="h-16 w-16 object-cover rounded-lg border border-emerald-500/30 shadow" onclick="openDetPhoto('${det.id}', ${i})"><span class="absolute -top-1 -left-1 bg-black/70 text-[9px] px-1 rounded-full">${i+1}</span></div>`).join('')
                            : '<div class="text-gray-500 text-[10px]">Geen foto\'s</div>';
                        parts.push(
                            '<div class="bg-gradient-to-br from-gray-900 via-gray-900 to-gray-800 border border-emerald-500/20 rounded-xl p-3 space-y-2 shadow-lg">' +
                                '<div class="flex items-start justify-between gap-2">' +
                                    '<div class="flex items-start gap-2">' +
                                        `<input type="checkbox" class="mt-1 share-det-checkbox checkbox-det" value="${det.id}">` +
                                        `<div><div class="font-bold text-white">${label}</div><div class="text-gray-400 text-[10px]">${answers.length} vragen ¬∑ ${photos} foto(s)</div></div>` +
                                    '</div>' +
                                    `<div class="text-[10px] text-gray-400">${ts}</div>` +
                                '</div>' +
                                (wiki ? `<div class="flex gap-2 items-center">${wiki}<div class="text-[10px] text-gray-400"></div></div>` : '') +
                                (ansBadges ? `<div class="flex flex-wrap gap-1">${ansBadges}</div>` : '<div class="text-gray-500 text-[10px]">Geen antwoorden</div>') +
                                (ansList ? `<div class="space-y-1 bg-black/20 border border-gray-800 rounded p-2">${ansList}</div>` : '') +
                                `<div class="flex gap-2 flex-wrap">${photoList}</div>` +
                            '</div>'
                        );
                    });
                    detBox.innerHTML = parts.join('');
                }
            }
        }

        function setReportMode(m) {
            reportMode = m;
            updateReport();
        }

        async function shareReport(includePhotos = false) {
            const day = ensureDay();
            const sel = document.getElementById('report-session-select');
            const sessionId = sel ? sel.value : '';
            const session = sessionId ? day.sessions.find(s => s.id === sessionId) : null;
            const text = document.getElementById('report-text').innerText || 'Geen data';
            let files = [];
            if(includePhotos) {
                const photos = reportMode === 'session' && session ? (session.photos||[]) : (day.photos||[]);
                if(!photos.length) { alert('Geen foto‚Äôs beschikbaar voor deze selectie.'); return; }
                files = photos.map((dataUrl, idx) => {
                    const res = dataURLToBlob(dataUrl);
                    return new File([res.blob], `paddentrek-${picker.value}-${idx+1}.${res.ext}`, { type: res.blob.type });
                });
            }

            const shareData = includePhotos ? { title: 'Paddentrek', text, files } : { title: 'Paddentrek', text };
            try {
                if(navigator.share) {
                    if(includePhotos) {
                        if(navigator.canShare && !navigator.canShare({ files })) {
                            throw new Error('FILES_NOT_SUPPORTED');
                        }
                    }
                    await navigator.share(shareData);
                    return;
                }
            } catch(err) {
                if(err?.name === 'AbortError') return;
                if(err?.message === 'FILES_NOT_SUPPORTED') {
                    alert('Je toestel ondersteunt geen delen met foto‚Äôs. Probeer zonder foto‚Äôs.');
                    return;
                }
            }
            // Fallback: kopieer tekst zodat gebruiker zelf kan plakken in een app naar keuze
            const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el);
            el.select(); document.execCommand('copy'); document.body.removeChild(el);
            alert('Rapport gekopieerd. Plak het in je favoriete app (Signal/WhatsApp/Messenger).');
        }

        async function shareDeterminaties() {
            const day = ensureDay();
            const sel = document.getElementById('report-session-select');
            const sessionId = sel ? sel.value : '';
            const session = sessionId ? day.sessions.find(s => s.id === sessionId) : null;
            let dets = (reportMode === 'session' && session)
                ? (session?.determinations || [])
                : (day.sessions || []).flatMap(s => s.determinations || []);
            const selected = Array.from(document.querySelectorAll('#report-dets .share-det-checkbox:checked')).map(cb => cb.value);
            if(selected.length) dets = dets.filter(d => selected.includes(d.id));
            if(!dets.length) { alert('Geen determinaties in deze selectie.'); return; }
            const lines = dets.map(d => {
                const ans = (d.answers||[]).map((a,idx)=>`${idx+1}. ${detQuestionText(a.node)} -> ${detAnswerLabel(a.answer)}`).join(' | ');
                const ts = new Date(d.updatedAt).toLocaleString('nl-BE');
                const fotos = (d.photos||[]).length;
                return `üîé ${d.resultName || 'Onbekend'}
‚Ä¢ Tijd: ${ts}
‚Ä¢ Antwoorden: ${ans || 'n.v.t.'}
‚Ä¢ Foto's: ${fotos}`;
            });
            const text = `üê∏ Determinaties ${picker.value} (${reportMode==='session' && session ? 'sessie' : 'dag'})

${lines.join('\n\n')}`;
            let files = [];
            const photos = dets.flatMap(d => d.photos || []).slice(0,10); // limiet om share API vriendelijk te houden
            if(photos.length) {
                files = photos.map((dataUrl, idx) => {
                    const res = dataURLToBlob(dataUrl);
                    return new File([res.blob], `det-${picker.value}-${idx+1}.${res.ext}`, { type: res.blob.type });
                });
            }
            const shareData = photos.length && navigator.canShare && navigator.canShare({ files })
                ? { title:'Determinaties', text, files }
                : { title:'Determinaties', text };
            try {
                if(navigator.share) {
                    await navigator.share(shareData);
                    return;
                }
            } catch(err) {
                if(err?.name === 'AbortError') return;
            }
            const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el);
            el.select(); document.execCommand('copy'); document.body.removeChild(el);
            alert('Determinaties gekopieerd. Plak in je app naar keuze.');
        }

        function exportReportCSV(forceDay = false) {
            const d = picker.value;
            const day = ensureDay();
            const sel = document.getElementById('report-session-select');
            const sessionId = sel ? sel.value : '';
            const session = (!forceDay && sessionId) ? day.sessions.find(s => s.id === sessionId) : null;
            const counts = reportMode === 'session' && session ? session.counts || {} : day.counts || {};
            const meta = reportMode === 'session' && session
                ? { route: session.routeName || '', notes: session.notes || '', weather: session.weather }
                : { route: '', notes: day.notes || '', weather: day.weather };
            const rows = [];
            rows.push(['Datum','Scope','Route','Notities','Weer temp','Weer code','Soort','Koppels levend','Koppels dood','M levend','V levend','Onb levend','M dood','V dood','Onb dood','Totaal']);
            const all = [...SPECIES, ...(day.custom || [])];
            all.forEach(s => {
                const pl = counts[`${s.id}_p_l`]||0, pd = counts[`${s.id}_p_d`]||0;
                const ml = counts[`${s.id}_m_l`]||0, vl = counts[`${s.id}_v_l`]||0, ol = counts[`${s.id}_o_l`]||0;
                const md = counts[`${s.id}_m_d`]||0, vd = counts[`${s.id}_v_d`]||0, od = counts[`${s.id}_o_d`]||0;
                const tot = pl*2+pd*2+ml+vl+ol+md+vd+od;
                if(tot>0) rows.push([
                    d,
                    session ? 'Sessie' : 'Dag',
                    meta.route,
                    meta.notes,
                    meta.weather?.t ?? '',
                    meta.weather?.c ?? '',
                    s.name, pl, pd, ml, vl, ol, md, vd, od, tot
                ]);
            });
            if(rows.length===1) rows.push(['Geen data',0,0,0,0,0,0,0,0,0]);
            downloadCSV(rows, session ? `paddentrek-${d}-${session.id}.csv` : `paddentrek-${d}-dag.csv`);
        }

        function downloadCSV(rows, name) {
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV opgeslagen');
        }

        function exportAllSessionsCSV() {
            const d = picker.value;
            const day = ensureDay();
            const rows = [['Datum','Scope','SessionId','Sessiestart','Sessie-einde','Route','Notities','Weer temp','Weer code','Soort','Koppels levend','Koppels dood','M levend','V levend','Onb levend','M dood','V dood','Onb dood','Totaal']];
            const addRows = (scopeLabel, counts, route, notes, wt, wc, sessStart='', sessEnd='', sessId='') => {
                const all = [...SPECIES, ...(day.custom || [])];
                all.forEach(s => {
                    const pl = counts[`${s.id}_p_l`]||0, pd = counts[`${s.id}_p_d`]||0;
                    const ml = counts[`${s.id}_m_l`]||0, vl = counts[`${s.id}_v_l`]||0, ol = counts[`${s.id}_o_l`]||0;
                    const md = counts[`${s.id}_m_d`]||0, vd = counts[`${s.id}_v_d`]||0, od = counts[`${s.id}_o_d`]||0;
                    const tot = pl*2+pd*2+ml+vl+ol+md+vd+od;
                    if(tot>0) rows.push([d, scopeLabel, sessId, sessStart, sessEnd, route, notes, wt, wc, s.name, pl, pd, ml, vl, ol, md, vd, od, tot]);
                });
            };
            if(day.sessions && day.sessions.length) {
                day.sessions.forEach(s => {
                    const wt = s.weather?.t ?? day.weather?.t ?? '';
                    const wc = s.weather?.c ?? day.weather?.c ?? '';
                    addRows('Sessie', s.counts||{}, s.routeName||'', s.notes||'', wt, wc, s.start||'', s.end||'', s.id||'');
                });
            }
            downloadCSV(rows, `paddentrek-${d}-sessies.csv`);
        }

        function copyReport() {
            const t = document.getElementById('report-text').innerText;
            const el = document.createElement('textarea'); el.value = t; document.body.appendChild(el);
            el.select(); document.execCommand('copy'); document.body.removeChild(el); showToast("Gekopieerd!");
        }

        // --- UPDATE BADGE ---
        const updateBtn = document.getElementById('update-btn');
        function showUpdateBadge(version) {
            if(!version || version === APP_VERSION) return; // niets nieuw
            updateBtn.classList.remove('hidden');
            updateBtn.innerText = `UPDATE ${version}`;
        }
        updateBtn.onclick = () => {
            updateBtn.innerText = 'Bezig...';
            updateBtn.disabled = true;
            navigator.serviceWorker.getRegistration().then(reg => reg?.update()).finally(() => location.reload());
        };

        function showToast(m) {
            const t = document.getElementById('toast'); t.innerText = m; t.classList.remove('hidden');
            setTimeout(() => t.style.opacity = '1', 10);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.classList.add('hidden'), 500); }, 2000);
        }

        function showDetModal(det) {
            const modal = document.getElementById('det-modal');
            const title = document.getElementById('det-modal-title');
            const rarity = document.getElementById('det-modal-rarity');
            const addBtn = document.getElementById('det-modal-add');
            if(!modal || !det) return;
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            if(title) title.innerText = cleanSpeciesName(det.resultName || det.result || 'Determinatie');
            const [label, cls] = rarityFor(det.result || det.resultName || '');
            if(rarity) {
                rarity.className = `rarity-pill ${cls}`;
                rarity.innerText = label;
            }
            const query = cleanSpeciesName(det.resultName || det.result || '').trim();
            const wikiBtn = document.getElementById('det-modal-link');
            const npBtn = document.getElementById('det-modal-link-np');
            currentDetLinks = { wiki: null, np: null };
            if(query) {
                const npName = toSlug(query);
                currentDetLinks.wiki = `https://nl.wikipedia.org/w/index.php?search=${encodeURIComponent(query)}`;
                currentDetLinks.np = `https://www.natuurpunt.be/soorten/amfibieen-reptielen/${npName}`;
                if(wikiBtn) {
                    wikiBtn.dataset.url = currentDetLinks.wiki;
                    wikiBtn.classList.remove('hidden');
                    wikiBtn.disabled = false;
                }
                if(npBtn) {
                    npBtn.dataset.url = currentDetLinks.np;
                    npBtn.classList.remove('hidden');
                    npBtn.disabled = false;
                }
            } else {
                if(wikiBtn) {
                    wikiBtn.dataset.url = '';
                    wikiBtn.classList.add('hidden');
                    wikiBtn.disabled = true;
                }
                if(npBtn) {
                    npBtn.dataset.url = '';
                    npBtn.classList.add('hidden');
                    npBtn.disabled = true;
                }
            }
            const sess = getDetSession();
            if(addBtn) addBtn.classList.toggle('hidden', !!sess?.detTemp); // verbergen bij losse determinatie
        }

        let currentDetLinks = { wiki:null, np:null };
        function openDetLink(type) {
            const id = type === 'np' ? 'det-modal-link-np' : 'det-modal-link';
            const btn = document.getElementById(id);
            let url = btn?.dataset?.url || currentDetLinks?.[type] || '';
            if(!url) {
                const q = (document.getElementById('det-modal-title')?.innerText || '').trim();
                if(q) {
                    if(type === 'np') url = `https://www.natuurpunt.be/soorten/amfibieen-reptielen/${toSlug(q)}`;
                    else url = `https://nl.wikipedia.org/w/index.php?search=${encodeURIComponent(q)}`;
                }
            }
            if(url) window.open(url, '_blank');
        }


        function closeDetModal(ev) {
            if(ev) ev.stopPropagation();
            const modal = document.getElementById('det-modal');
            if(modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        function buildQRSessionOptions() {
            const sel = document.getElementById('qr-session-select');
            if(!sel) return;
            const day = ensureDay();
            sel.innerHTML = '<option value=\"\">Alle sessies (dagtotaal)</option>' + day.sessions.map(s => {
                const label = `${fmtTime(s.start)} ${s.end ? '‚Äì '+fmtTime(s.end) : '(live)'}`;
                return `<option value="${s.id}">${label}</option>`;
            }).join('');
        }

        function buildReportSessionOptions() {
            const sel = document.getElementById('report-session-select');
            if(!sel) return;
            const day = ensureDay();
            sel.innerHTML = '<option value=\"\">Alle sessies</option>' + day.sessions.map(s => {
                const label = `${fmtTime(s.start)} ${s.end ? '‚Äì '+fmtTime(s.end) : '(live)'}${s.routeName ? ' ¬∑ '+s.routeName : ''}`;
                return `<option value="${s.id}">${label}</option>`;
            }).join('');
            sel.value = '';
        }

        function buildRouteSuggestions() {
            const dl = document.getElementById('route-suggestions');
            if(!dl) return;
            const names = new Set();
            for(const d in storage) {
                const day = ensureDay(d);
                (day.sessions || []).forEach(s => { if(s.routeName) names.add(s.routeName); });
            }
            dl.innerHTML = Array.from(names).slice(0,50).map(n => `<option value="${n}"></option>`).join('');
        }

        function generateQR() {
            const d = picker.value;
            const container = document.getElementById("qrcode-area"); if(container) container.innerHTML = "";
            const sel = document.getElementById('qr-session-select');
            const sessionId = sel ? sel.value : '';
            const day = ensureDay(d);
            const session = sessionId ? day.sessions.find(s => s.id === sessionId) : null;
            const counts = session ? session.counts || {} : day.counts || {};
            const payload = { d, c: counts, s: day.custom || [], sess: sessionId || null };
            new QRCode(container, { text: JSON.stringify(payload), width: 160, height: 160, correctLevel: QRCode.CorrectLevel.L });
            updateQrSummary();
        }

        function updateQrSummary() {
            const d = picker.value;
            const sel = document.getElementById('qr-session-select');
            const box = document.getElementById('qr-summary-box');
            if(!sel || !box) return;
            const sessionId = sel.value;
            const day = ensureDay(d);
            const session = sessionId ? day.sessions.find(s => s.id === sessionId) : null;
            const counts = session ? session.counts || {} : day.counts || {};
            const total = sumCounts(counts);
            let lines = [`Dag: ${d}`, `Bron: ${session ? `Sessie ${fmtTime(session.start)}${session.end ? ' ‚Äì '+fmtTime(session.end) : ''}` : 'Volledige dag'}`, `Totaal dieren: ${total}`];
            const perSpecies = {};
            for(const k in counts) {
                const [sid, suf] = k.split('_');
                perSpecies[sid] = perSpecies[sid] || 0;
                perSpecies[sid] += counts[k] * (suf.includes('p_') ? 2 : 1);
            }
            Object.entries(perSpecies).sort((a,b)=>b[1]-a[1]).slice(0,4).forEach(([sid, val]) => {
                const name = (SPECIES.find(s=>s.id===sid) || (day.custom||[]).find(c=>c.id===sid) || {name:sid}).name;
                lines.push(`${name}: ${val}`);
            });
            box.innerText = `Wie deze QR scant, telt dit bij zichzelf op:\n\n${lines.join('\n')}`;
        }

        function exportRangeCSV(forceSettings = false) {
            const from = document.getElementById(forceSettings ? 'csv-from-settings' : 'csv-from')?.value || picker.value;
            const to = document.getElementById(forceSettings ? 'csv-to-settings' : 'csv-to')?.value || picker.value;
            const dates = Object.keys(storage).filter(d => d >= from && d <= to).sort();
            const rows = [['Datum','Scope','SessionId','Sessiestart','Sessie-einde','Route','Notities','Weer temp','Weer code','Soort','Koppels levend','Koppels dood','M levend','V levend','Onb levend','M dood','V dood','Onb dood','Totaal']];
            dates.forEach(d => {
                const day = ensureDay(d);
                const addRows = (scopeLabel, counts, route, notes, wt, wc, sessStart='', sessEnd='', sessId='') => {
                    const all = [...SPECIES, ...(day.custom || [])];
                    all.forEach(s => {
                        const pl = counts[`${s.id}_p_l`]||0, pd = counts[`${s.id}_p_d`]||0;
                        const ml = counts[`${s.id}_m_l`]||0, vl = counts[`${s.id}_v_l`]||0, ol = counts[`${s.id}_o_l`]||0;
                        const md = counts[`${s.id}_m_d`]||0, vd = counts[`${s.id}_v_d`]||0, od = counts[`${s.id}_o_d`]||0;
                        const tot = pl*2+pd*2+ml+vl+ol+md+vd+od;
                        if(tot>0) rows.push([d, scopeLabel, sessId, sessStart, sessEnd, route, notes, wt, wc, s.name, pl, pd, ml, vl, ol, md, vd, od, tot]);
                    });
                };
                if(day.sessions && day.sessions.length) {
                    day.sessions.forEach(s => {
                        const wt = s.weather?.t ?? day.weather?.t ?? '';
                        const wc = s.weather?.c ?? day.weather?.c ?? '';
                        addRows('Sessie', s.counts||{}, s.routeName||'', s.notes||'', wt, wc, s.start||'', s.end||'', s.id || '');
                    });
                }
                // ook dagtotaal opnemen
                addRows('Dag', day.counts||{}, '', day.notes||'', day.weather?.t ?? '', day.weather?.c ?? '', '', '', 'day-'+d);
            });
            if(rows.length===1) rows.push(['Geen data',0,0,0,0,0,0,0,0,0,0]);
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `paddentrek-${from}-tot-${to}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV range opgeslagen');
        }

        function handleCSVImport() {
            const input = document.getElementById('csv-import-input');
            const res = document.getElementById('csv-import-result');
            if(!input?.files?.length) { res.innerText = 'Geen bestand gekozen.'; return; }
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = () => {
                const text = reader.result;
                const { added, days } = importCSV(text);
                res.innerText = `Ge√Ømporteerd: ${added} records over ${days.size} dagen.`;
                save(); render(); renderSessionAdmin(); updateReport(); buildRouteSuggestions();
            };
            reader.readAsText(file);
        }

        function importCSV(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim().length);
            if(!lines.length) return { added:0, days:new Set() };
            const delim = lines[0].includes(';') ? ';' : ',';
            const clean = v => v.replace(/^\"|\"$/g,'').trim().toLowerCase();
            const header = lines[0].split(delim).map(clean);
            const idx = {
                date: header.findIndex(h => h.startsWith('datum')),
                soort: header.findIndex(h => h.startsWith('soort')),
                pl: header.findIndex(h => h.includes('koppels levend')),
                pd: header.findIndex(h => h.includes('koppels dood')),
                ml: header.findIndex(h => h.startsWith('m ') && h.includes('levend')) === -1 ? header.findIndex(h=>h==='m levend') : header.findIndex(h => h.startsWith('m') && h.includes('levend')),
                vl: header.findIndex(h => h.startsWith('v') && h.includes('levend')),
                ol: header.findIndex(h => h.includes('onb') && h.includes('levend')),
                md: header.findIndex(h => h.startsWith('m') && h.includes('dood')),
                vd: header.findIndex(h => h.startsWith('v') && h.includes('dood')),
                od: header.findIndex(h => h.includes('onb') && h.includes('dood')),
                route: header.findIndex(h => h.startsWith('route')),
                notes: header.findIndex(h => h.startsWith('notities') || h.startsWith('nota')),
                wt: header.findIndex(h => h.includes('weer temp')),
                wc: header.findIndex(h => h.includes('weer code')),
                scope: header.findIndex(h => h === 'scope'),
                sessStart: header.findIndex(h => h.startsWith('sessiestart')),
                sessEnd: header.findIndex(h => h.startsWith('sessie-einde')),
                sessId: header.findIndex(h => h === 'sessionid'),
            };
            let added = 0;
            const days = new Set();
            const importSessions = {}; // key -> session
            const sessionsSeen = {};
            const fallbackCounts = {};
            const fallbackMeta = {};
            for(let i=1;i<lines.length;i++){
                const cols = lines[i].split(delim).map(c => c.replace(/^\"|\"$/g,'').trim());
                const date = cols[idx.date] || picker.value;
                const speciesName = cols[idx.soort] || 'Onbekend';
                if(!date || !speciesName) continue;
                const day = ensureDay(date);
                days.add(date);
                const scope = idx.scope>=0 ? cols[idx.scope].toLowerCase() : '';
                const startRaw = idx.sessStart>=0 ? cols[idx.sessStart] : '';
                const endRaw = idx.sessEnd>=0 ? cols[idx.sessEnd] : '';
                const sessIdCsv = idx.sessId>=0 ? cols[idx.sessId] : '';
                let sess = null;
                const isSessionRow = scope.includes('sessie');
                if(isSessionRow) {
                    const key = sessIdCsv || `${date}_${startRaw||'00:00'}`;
                    if(!importSessions[key]) {
                        const startIso = startRaw ? new Date(startRaw).toISOString() : new Date(`${date}T00:00:00`).toISOString();
                        const endIso = endRaw ? new Date(endRaw).toISOString() : null;
                        const existing = day.sessions.find(s => s.id === sessIdCsv);
                        sess = existing || { id: sessIdCsv || `import_${key}_${i}`, start: startIso, end: endIso, counts: {}, notes: cols[idx.notes] || 'CSV import', photos: [], routeName: cols[idx.route] || 'CSV import', weather: null, determinations: [] };
                        if(!existing) day.sessions.push(sess);
                        importSessions[key] = sess;
                    } else {
                        sess = importSessions[key];
                    }
                    sessionsSeen[date] = true;
                }
                // fallback dagtotaal verzamelen, pas later toepassen
                if(!isSessionRow) {
                    if(!fallbackCounts[date]) fallbackCounts[date] = {};
                    const route = cols[idx.route] || '';
                    const notes = cols[idx.notes] || '';
                    const wt = idx.wt>=0 ? parseFloat(cols[idx.wt].replace(',','.')) : null;
                    const wc = idx.wc>=0 ? parseInt(cols[idx.wc]) : null;
                    if(!fallbackMeta[date]) fallbackMeta[date] = { route, notes, wt, wc };
                }
                if(idx.wt >=0 || idx.wc >=0) {
                    const wt = idx.wt>=0 ? parseFloat(cols[idx.wt].replace(',','.')) : null;
                    const wc = idx.wc>=0 ? parseInt(cols[idx.wc]) : null;
                    if(sess) {
                        if(!sess.weather && (wt || wc)) {
                            sess.weather = { t: wt ?? 0, c: isFinite(wc)? wc : 0, ts: Date.now() };
                            day.weather = day.weather || sess.weather;
                        }
                    } else {
                        // day-row: bewaar in fallbackMeta zodat we het later kunnen toepassen
                        const fm = fallbackMeta[date] || {};
                        if(wt !== null) fm.wt = wt;
                        if(wc !== null && isFinite(wc)) fm.wc = wc;
                        fallbackMeta[date] = fm;
                    }
                }

                let species = SPECIES.find(s => s.name.toLowerCase() === speciesName.toLowerCase());
                if(!species) {
                    species = day.custom.find(c => c.name.toLowerCase() === speciesName.toLowerCase());
                    if(!species) {
                        species = { id: 'c_'+Date.now()+Math.random().toString(16).slice(2), name: speciesName, color: 'gray', hasAmplexus: true };
                        day.custom.push(species);
                    }
                }
                const counts = day.counts;
                const addVal = (field, val, targetCounts) => {
                    if(isNaN(val)) return;
                    const key = `${species.id}_${field}`;
                    targetCounts[key] = (targetCounts[key]||0) + val;
                };
                const num = k => {
                    const v = idx[k] >=0 ? parseFloat(cols[idx[k]].replace(',','.')) : 0;
                    return isFinite(v) ? v : 0;
                };
                if(isSessionRow) {
                    addVal('p_l', num('pl'), sess.counts);
                    addVal('p_d', num('pd'), sess.counts);
                    addVal('m_l', num('ml'), sess.counts);
                    addVal('v_l', num('vl'), sess.counts);
                    addVal('o_l', num('ol'), sess.counts);
                    addVal('m_d', num('md'), sess.counts);
                    addVal('v_d', num('vd'), sess.counts);
                    addVal('o_d', num('od'), sess.counts);
                } else {
                    addVal('p_l', num('pl'), fallbackCounts[date]);
                    addVal('p_d', num('pd'), fallbackCounts[date]);
                    addVal('m_l', num('ml'), fallbackCounts[date]);
                    addVal('v_l', num('vl'), fallbackCounts[date]);
                    addVal('o_l', num('ol'), fallbackCounts[date]);
                    addVal('m_d', num('md'), fallbackCounts[date]);
                    addVal('v_d', num('vd'), fallbackCounts[date]);
                    addVal('o_d', num('od'), fallbackCounts[date]);
                }
                added++;
            }
            // apply fallbacks and recalc day totals from sessions
            days.forEach(d => {
                const day = ensureDay(d);
                if(sessionsSeen[d]) {
                    recalcDayFromSessions(day);
                } else if(fallbackCounts[d]) {
                    day.counts = fallbackCounts[d];
                    const meta = fallbackMeta[d] || {};
                    // maak een dag-importsessie zodat log iets toont
                    const startIso = new Date(`${d}T00:00:00`).toISOString();
                    const endIso = new Date(`${d}T23:59:00`).toISOString();
                    day.sessions.push({ id:`import_${d}_day`, start:startIso, end:endIso, counts:{...fallbackCounts[d]}, notes: meta.notes||'', photos: [], routeName: meta.route||'', weather: (meta.wt||meta.wc) ? {t:meta.wt||0, c:meta.wc||0, ts:Date.now()} : null, determinations: [] });
                }
            });
            purgeEmptyCustomSpecies();
            return { added, days };
        }

        function describeSync(incoming) {
            const label = {
                p_l: '‚ù§Ô∏è koppels', p_d: '‚ò†Ô∏è koppels', m_l: 'm levend', v_l: 'v levend', o_l: 'o levend',
                m_d: 'm dood',   v_d: 'v dood',   o_d: 'o dood'
            };
            const nameFor = id => {
                const base = SPECIES.find(s => s.id === id);
                if(base) return base.name;
                const inc = (incoming.s || []).find(s => s.id === id);
                return inc ? inc.name : id;
            };

            const perSpecies = {};
            for(const k in incoming.c || {}) {
                const [sid, suf] = k.split('_');
                if(!perSpecies[sid]) perSpecies[sid] = [];
                perSpecies[sid].push(`${incoming.c[k]} √ó ${label[suf] || suf}`);
            }

            const lines = Object.entries(perSpecies).map(([sid, items]) => `- ${nameFor(sid)}: ${items.join(', ')}`);

            const existingCustom = (storage[incoming.d]?.custom) || [];
            const newCustom = (incoming.s || []).filter(s => !existingCustom.some(c => c.name === s.name));
            if(newCustom.length) lines.push(`+ Nieuwe soorten: ${newCustom.map(s => s.name).join(', ')}`);

            return lines.length ? `Toegevoegd op ${incoming.d}:\n${lines.join('\n')}` : 'Geen teldata ontvangen.';
        }

        function startScanner() {
            const sc = new Html5Qrcode("reader");
            sc.start({ facingMode: "environment" }, { fps: 10, qrbox: 200 }, t => {
                try {
                    const i = JSON.parse(t);
                    const summary = describeSync(i);
                    const day = ensureDay(i.d);
                    for(let k in i.c) day.counts[k] = (day.counts[k] || 0) + i.c[k];
                    (i.s||[]).forEach(si => { if(!day.custom.some(c => c.name===si.name)) day.custom.push(si); });
                    save(); buildUI(); render(); sc.stop(); alert(summary); showToast("Partner gesynct!"); switchTab('count');
                } catch(e) { alert("QR fout"); }
            }).catch(() => alert("Camera fout"));
        }

        function startSessionScanner() {
            const modal = document.getElementById('qr-modal');
            modal.classList.remove('hidden');
            const targetId = 'session-reader-modal';
            if(sessionScanner) { sessionScanner.stop().catch(()=>{}); sessionScanner = null; }
            sessionScanner = new Html5Qrcode(targetId);
            sessionScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 220 }, t => {
                try {
                    const i = JSON.parse(t);
                    const summary = describeSync(i);
                    const day = ensureDay(i.d);
                    const targetSessionId = document.getElementById('import-target-select')?.value || '';
                    for(let k in i.c) day.counts[k] = (day.counts[k] || 0) + i.c[k];
                    if(targetSessionId) {
                        const ts = day.sessions.find(s => s.id === targetSessionId);
                        if(ts) {
                            for(let k in i.c) ts.counts[k] = (ts.counts[k] || 0) + i.c[k];
                        }
                    }
                    (i.s||[]).forEach(si => { if(!day.custom.some(c => c.name===si.name)) day.custom.push(si); });
                    save(); buildUI(); render(); stopSessionScanner(); alert(summary); showToast("Sessies ge√Ømporteerd"); switchTab('sessions');
                } catch(e) { alert("QR fout"); }
            }).catch(() => alert("Camera fout"));
        }

        function stopSessionScanner() {
            if(sessionScanner) {
                sessionScanner.stop().catch(()=>{}).finally(()=> sessionScanner = null);
            }
        }

        function closeQrModal(ev) {
            const modal = document.getElementById('qr-modal');
            if(ev.target.id === 'qr-modal' || ev.target.tagName === 'BUTTON') {
                stopSessionScanner();
                modal.classList.add('hidden');
                document.getElementById('session-reader-modal').innerHTML = '';
            }
        }

        function buildImportTargetOptions() {
            const sel = document.getElementById('import-target-select');
            const hint = document.getElementById('import-target-hint');
            if(!sel || !hint) return;
            const day = ensureDay();
            const sessions = day.sessions.slice().sort((a,b)=>new Date(a.start)-new Date(b.start));
            sel.innerHTML = `<option value=\"\">Dag ${picker.value} (dagtotaal)</option>` +
                sessions.map(s => `<option value="${s.id}">${fmtTime(s.start)} ${s.end ? '‚Äì '+fmtTime(s.end) : '(live)'}</option>`).join('');
            sel.value = '';
            updateImportTargetHint();
        }

        function updateImportTargetHint() {
            const sel = document.getElementById('import-target-select');
            const hint = document.getElementById('import-target-hint');
            if(!sel || !hint) return;
            const val = sel.value;
            if(!val) {
                hint.innerText = `Tellen uit de QR worden bij het dagtotaal van ${picker.value} opgeteld.`;
            } else {
                hint.innerText = `Tellen uit de QR worden bijgeteld in sessie ${sel.selectedOptions[0].textContent}.`;
            }
        }

        function switchTab(t) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            const view = document.getElementById('view-' + t);
            if(view) view.classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
            const tab = document.getElementById('tab-' + t);
            if(tab) tab.classList.add('active-tab');
            if(t==='report') { buildReportSessionOptions(); updateReport(); }
            if(t==='sessions') { renderSessionLog(); }
            if(t==='settings') {
                const sd = document.getElementById('sessionDate');
                if(sd) sd.value = picker.value;
                const pd = document.getElementById('photo-clean-date');
                if(pd) pd.value = picker.value;
                renderSessionAdmin();
                buildQRSessionOptions();
                buildImportTargetOptions();
                generateQR();
                renderStorageInspector(true);
            }
            if(t==='help') {
                renderDetSessionOptions();
                renderDeterminationUI();
                renderDeterminationList();
            }
        }

        function resetCurrentDate() { if(confirm("Alles wissen voor vandaag?")) { delete storage[picker.value]; save(); buildUI(); render(); } }

        picker.onchange = () => { buildUI(); render(); buildQRSessionOptions(); buildReportSessionOptions(); renderSessionAdmin(); };
        document.getElementById('sessionDate').onchange = () => renderSessionAdmin();
        splitSessionOverMidnightIfNeeded();
        buildUI(); render(); renderSessionAdmin(); buildQRSessionOptions(); buildReportSessionOptions(); renderDetSessionOptions(); renderDeterminationUI(); renderDeterminationList();
    </script>
</body>
</html>
